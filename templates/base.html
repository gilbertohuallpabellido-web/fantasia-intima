{% load static theme_tags math_filters %}

<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    {% block meta_viewport %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    {% endblock %}
    {% if build_commit %}
    <meta name="build-commit" content="{{ build_commit }}" />
    {% endif %}
    <title>{% block title %}Fantasía Íntima{% endblock %}</title>
    <link rel="icon" href="{% static 'productos/logo.png' %}" type="image/png">
    
    <!-- Bloques para SEO y Redes Sociales -->
    <meta name="description" content="{% block meta_description %}Descubre lencería y fantasías íntimas diseñadas para despertar tus sentidos. Calidad, sensualidad y discreción en cada detalle.{% endblock %}">
    <meta property="og:title" content="{% block og_title %}{{ block.super }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Descubre lencería y fantasías íntimas diseñadas para despertar tus sentidos. Calidad, sensualidad y discreción en cada detalle.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% static 'productos/logo_share.png' %}{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Fantasía Íntima">
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ block.super }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Descubre lencería y fantasías íntimas diseñadas para despertar tus sentidos. Calidad, sensualidad y discreción en cada detalle.{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{% static 'productos/logo_share.png' %}{% endblock %}">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/mobile_catalog.css' %}">
    
    <!-- Librerías para Sonido y Animación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    {% inject_theme_styles %}

    <style>
        /* === INICIO DE LA MEJORA: Solución Anti-Parpadeo (FOUC) === */
        [x-cloak] { display: none !important; }
        /* === FIN DE LA MEJORA === */

        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgb(236 72 153 / 0.1), 0 8px 10px -6px rgb(236 72 153 / 0.1);
        }
    .social-icon:hover, #chat-button:hover { transform: scale(1.1); }
    /* === Estilos globales ruleta (botón premium) === */
    .premium-spin-btn{background:radial-gradient(circle at 30% 30%,var(--brand-accent) 0%,var(--brand-primary,#ff5fa3) 55%,var(--brand-secondary,#ff2d55) 100%);box-shadow:0 8px 24px -6px rgba(0,0,0,.55),0 4px 12px -4px rgba(0,0,0,.4);position:relative;overflow:visible;}
    .premium-spin-btn:before{content:"";position:absolute;inset:-5px;border-radius:50%;padding:2px;background:conic-gradient(from 0deg,#ffd36d,#ff63a1,#ffd36d 320deg);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;filter:blur(6px);opacity:.55;transition:opacity .6s ease,filter .6s ease;}
    .premium-spin-btn:hover:before{opacity:1;filter:blur(3px) brightness(1.15);}     
    .premium-spin-btn:after{content:"";position:absolute;inset:0;border-radius:inherit;background:linear-gradient(145deg,rgba(255,255,255,.22),rgba(255,255,255,.05));mix-blend-mode:overlay;pointer-events:none;}
    .premium-spin-btn .roulette-inner{width:100%;height:100%;display:flex;align-items:center;justify-content:center;border-radius:inherit;font-size:1.9rem;}
    .premium-spin-btn .roulette-inner{background:radial-gradient(circle at 65% 35%,rgba(255,255,255,.55),rgba(255,255,255,.05) 70%), linear-gradient(135deg,rgba(255,255,255,.2),rgba(255,255,255,.05));backdrop-filter:blur(8px) saturate(140%);-webkit-backdrop-filter:blur(8px) saturate(140%);box-shadow:inset 0 0 0 1px rgba(255,255,255,.35),inset 0 0 14px -4px rgba(255,255,255,.8),0 4px 16px -4px rgba(0,0,0,.5);animation:pulse-glow 4.5s ease-in-out infinite;}
    @keyframes pulse-glow{0%,100%{transform:scale(1)}50%{transform:scale(1.045);}}
    .premium-spin-btn:hover .roulette-inner{animation-play-state:paused;}
    .spark{position:absolute;background:radial-gradient(circle,#fff 0%,rgba(255,255,255,0) 70%);border-radius:50%;opacity:0;animation:sparkle 3.2s linear infinite;mix-blend-mode:screen;}
    .spark-1{width:14px;height:14px;top:8px;left:10px;animation-delay:.3s;}
    .spark-2{width:10px;height:10px;bottom:10px;right:14px;animation-delay:1.4s;}
    .spark-3{width:8px;height:8px;top:14px;right:12px;animation-delay:2.2s;}
    @keyframes sparkle{0%{opacity:0;transform:scale(.2) translateY(0)}10%{opacity:1;transform:scale(1) translateY(-2px)}40%{opacity:0;transform:scale(.6) translateY(-4px)}100%{opacity:0;}}
    .roulette-tooltip{position:absolute;top:-42px;left:50%;transform:translateX(-50%) translateY(6px);background:rgba(30,30,30,.85);color:#fff;font-size:.65rem;font-weight:600;padding:6px 10px;border-radius:999px;white-space:nowrap;opacity:0;pointer-events:none;letter-spacing:.5px;transition:opacity .35s ease, transform .4s cubic-bezier(.19,.8,.25,1);box-shadow:0 6px 18px -6px rgba(0,0,0,.6),0 2px 6px -2px rgba(0,0,0,.35);}
    .premium-spin-btn:hover .roulette-tooltip,.premium-spin-btn:focus-visible .roulette-tooltip{opacity:1;transform:translateX(-50%) translateY(0);}
    .premium-spin-btn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 14px 32px -10px rgba(0,0,0,.6),0 6px 16px -4px rgba(0,0,0,.45);} 
    .premium-spin-btn:active{transform:translateY(0) scale(.97);transition:transform .12s ease;} 
    @supports not ((backdrop-filter: blur(4px)) or (-webkit-backdrop-filter: blur(4px))){
        .premium-spin-btn .roulette-inner{background:linear-gradient(135deg,rgba(255,255,255,.18),rgba(255,255,255,.05));}
    }

    /* === VIDA EXTRA RULETA: efectos de atracción y callout === */
    @keyframes attractPulse {0%{box-shadow:0 0 0 0 rgba(236,72,153,.55);}70%{box-shadow:0 0 0 22px rgba(236,72,153,0);}100%{box-shadow:0 0 0 0 rgba(236,72,153,0);} }
    .premium-spin-btn.attract:after{animation:attractPulse 2.8s ease-out infinite;}
    @keyframes floatY {0%,100%{transform:translate(-50%,0);}50%{transform:translate(-50%,-6px);} }
    .roulette-fab-callout{position:absolute;top:-58px;left:50%;transform:translateX(-50%);background:linear-gradient(145deg,var(--brand-accent),var(--brand-primary,#ff5fa3));color:#fff;font-size:.65rem;font-weight:700;padding:6px 14px;border-radius:999px;letter-spacing:.5px;text-shadow:0 2px 6px rgba(0,0,0,.4);box-shadow:0 10px 18px -6px rgba(0,0,0,.45),0 4px 10px -4px rgba(0,0,0,.35);display:flex;align-items:center;gap:.35rem;white-space:nowrap;animation:floatY 5.5s ease-in-out infinite;pointer-events:none;}
    .roulette-fab-callout i{font-size:.8rem;}
    .premium-spin-btn:hover .roulette-fab-callout{animation-play-state:paused;}
    @media (max-width:640px){
        #roulette-fab-mobile .roulette-fab-callout{top: -50px; font-size:.6rem;}
    }

    /* Mini badge de countdown en FAB móvil */
    .fi-mini-countdown{position:absolute; top:-6px; right:-6px; background:#fff; color:var(--brand-accent); font-weight:800; font-size:.65rem; line-height:1; padding:.22rem .38rem; border-radius:999px; border:1px solid rgba(255,255,255,.6); box-shadow:0 6px 14px -6px rgba(0,0,0,.45); min-width:28px; text-align:center; letter-spacing:.2px;}
    @media (max-width:640px){ .fi-mini-countdown{font-size:.62rem; top:-5px; right:-5px; } }

    /* === Ruleta: estilos de rueda y texto de premios === */
    #roulette-wheel { position: relative; overflow: visible; aspect-ratio:1/1; box-shadow:0 10px 28px -8px rgba(0,0,0,.35),0 4px 10px -4px rgba(0,0,0,.25); }
    /* Capa de profundidad y brillo */
    #roulette-wheel:before{content:"";position:absolute;inset:0;border-radius:50%;pointer-events:none;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.4),rgba(255,255,255,0) 60%),radial-gradient(circle at 70% 75%,rgba(255,255,255,.25),rgba(255,255,255,0) 65%);mix-blend-mode:overlay;}
    /* Separadores sutiles entre segmentos usando máscara */
    #roulette-wheel:after{content:"";position:absolute;inset:0;border-radius:50%;pointer-events:none;background:repeating-conic-gradient(rgba(255,255,255,.7) 0deg,rgba(255,255,255,.7) 1deg,transparent 1deg,transparent 45deg);mask:radial-gradient(circle at 50% 50%,transparent 0 58%,#000 59% 100%);opacity:.55;mix-blend-mode:overlay;}
    .dark #roulette-wheel:after{opacity:.35;}
    .roulette-pointer{animation:pointerPulse 2.6s ease-in-out infinite;}
    @keyframes pointerPulse{0%,100%{transform:translate(-50%,0) scale(1)}50%{transform:translate(-50%,2px) scale(1.06)}}
    .roulette-center-shadow{position:absolute;inset:0;border-radius:50%;box-shadow:inset 0 0 22px -6px rgba(0,0,0,.55),inset 0 4px 14px -4px rgba(0,0,0,.4);pointer-events:none;}
    
    /* === INICIO DE LA MEJORA: CSS para el Texto de la Ruleta === */
    #roulette-wheel .prize-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: 0% 50%;
        font-weight: 800;
        color: #fff;
        letter-spacing: .5px;
        pointer-events: none;
        text-transform: uppercase;
    white-space: normal; /* permitir salto */
    text-align: center; /* centrado horizontal */
        text-shadow: 0 2px 4px rgba(0,0,0,.65), 0 0 6px rgba(0,0,0,.45);
        filter: drop-shadow(0 2px 3px rgba(0,0,0,.55));
    font-size: 0.78rem;
    line-height: 1.08;
    padding: 0 .25rem 0 .1rem;
    width: 48%; /* longitud radial máxima (desde centro hacia borde) */
    max-width: 48%;
    text-align: center; /* para que las líneas empiecen alineadas hacia fuera */
    display: block; /* volvemos a usar texto tangencial */
    pointer-events:none;
    will-change: transform;
    }
    @media (min-width: 640px) {
        #roulette-wheel .prize-text {
            font-size: 0.85rem;
        }
    }
    /* === FIN DE LA MEJORA === */

    /* Texto central / hub */
    .roulette-hub-label{letter-spacing:.5px;text-shadow:0 2px 5px rgba(0,0,0,.35);}    

    /* Texto curvo SVG */
    #roulette-wheel svg { overflow: visible; }
    .arc-label { font-weight:800; fill:#fff; letter-spacing:.5px; text-transform:uppercase; font-family:inherit; paint-order:stroke; stroke:#000; stroke-width:6px; stroke-linejoin:round; stroke-opacity:.38; }
    .arc-label.small { font-size:30px; }
    .arc-label.medium { font-size:34px; }
    .arc-label.large { font-size:38px; }
    .arc-label.xl { font-size:42px; }
    @media (max-width:640px){
        .arc-label.xl { font-size:34px; }
        .arc-label.large { font-size:32px; }
        .arc-label.medium { font-size:30px; }
        .arc-label.small { font-size:26px; }
    }

    /* Accesibilidad (lector de pantalla) */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    .roulette-modal-overlay{z-index:9999;}

    /* 🚫 Bloquear scroll de toda la página cuando hay zoom */
    .disable-scroll {
      overflow: hidden !important;
      height: 100%;
      touch-action: none;
      position: fixed;
      width: 100%;
    }

    /* Oculta la barra de migas (que generaba una franja blanca) en páginas con hero/banner como el catálogo */
    body.catalog-page .breadcrumbs-bar { display: none; }

    /* Ajustes flotantes SOLO en móvil (para no tapar la barra inferior) */
    @media (max-width: 639.98px){
        body.catalog-page #social-wrapper { bottom: 88px; }
    /* Reubicar chat aún más arriba para despegarlo totalmente de la barra inferior */
    /* Elevar todo el wrapper del chat (botón + panel) */
    /* Altura intermedia para el chat (no tan alto, sin cubrir barra inferior) */
    body.catalog-page #chat-wrapper { bottom: 70px !important; right: 1rem !important; left: auto; }
    body.catalog-page #chat-button { bottom: auto !important; }
    body.catalog-page #chat-container { bottom: 220px !important; right: 1rem !important; }
        /* Se elimina ubicación inferior de la ruleta para usar posición superior */
    }

    /* Ruleta ahora se maneja dentro del header (mobile absolute, desktop fixed) */

    /* === Texto GANASTE grande (aparece sólo al ganar) === */
    #big-win-text {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(.7);
        font-size: clamp(3rem, 12vw, 5.2rem);
        font-weight: 900;
        letter-spacing: 2px;
        color: #fff;
        padding: 1rem 2.5rem 1.2rem;
        border-radius: 2.5rem;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
        backdrop-filter: blur(8px) saturate(160%);
        -webkit-backdrop-filter: blur(8px) saturate(160%);
        box-shadow: 0 8px 32px -8px rgba(0,0,0,0.55), 0 4px 14px -4px rgba(0,0,0,0.4), inset 0 0 0 2px rgba(255,255,255,0.18);
        text-shadow: 0 4px 18px rgba(0,0,0,0.55), 0 0 6px rgba(255,255,255,0.4);
        opacity: 0;
        pointer-events: none;
        z-index: 100000;
        mix-blend-mode: normal;
        transition: opacity .55s ease, transform .65s cubic-bezier(.19,1,.22,1);
        font-family: inherit;
        background-image: linear-gradient(135deg, var(--brand-accent), var(--brand-primary,#ff5fa3));
    background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
    }
    #big-win-text:before{
        content:"";
        position:absolute;inset:0;border-radius:inherit;z-index:-1;
        background:linear-gradient(145deg,var(--brand-accent),var(--brand-primary,#ff5fa3));
        filter:blur(18px) brightness(1.1);opacity:.55;pointer-events:none;
    }
    #big-win-text.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    @media (prefers-reduced-motion: reduce){
        #big-win-text { transition: opacity .4s linear; transform: translate(-50%, -50%) scale(1); }
        #big-win-text.show { opacity:1; }
    }

    /* === Toast Promocional Ruleta === */
    #roulette-promo-toast { position:fixed; left:50%; bottom:-220px; transform:translateX(-50%); width:calc(100% - 2rem); max-width:420px; background:linear-gradient(135deg,var(--brand-accent),var(--brand-primary,#ff5fa3)); color:#fff; border-radius:1.25rem; padding:0.9rem 1.1rem 1rem; box-shadow:0 16px 36px -12px rgba(0,0,0,.45),0 6px 16px -6px rgba(0,0,0,.35); z-index:50000; display:flex; gap:.75rem; align-items:flex-start; font-family:inherit; line-height:1.15; letter-spacing:.3px; backdrop-filter:blur(8px) saturate(160%); -webkit-backdrop-filter:blur(8px) saturate(160%); }
    #roulette-promo-toast.show { transition:bottom .75s cubic-bezier(.19,1,.22,1); bottom:calc(env(safe-area-inset-bottom, 0px) + .9rem); }
    #roulette-promo-toast.hide { bottom:-240px; }
    #roulette-promo-toast .icon-wrap { width:48px; height:48px; flex:0 0 48px; border-radius:1rem; background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.85),rgba(255,255,255,.15)); display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px -6px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.3); position:relative; }
    #roulette-promo-toast .icon-wrap:after { content:""; position:absolute; inset:0; border-radius:inherit; background:conic-gradient(from 0deg,rgba(255,255,255,.6),rgba(255,255,255,0) 70%); mix-blend-mode:overlay; opacity:.5; }
    #roulette-promo-toast h4 { font-size:1rem; font-weight:800; margin:0 0 .15rem; text-shadow:0 2px 6px rgba(0,0,0,.35); }
    #roulette-promo-toast p { font-size:.78rem; margin:0 0 .55rem; opacity:.95; font-weight:500; display:block; overflow:visible; white-space:normal; word-break:break-word; hyphens:auto; }
    #roulette-promo-toast button.promo-spin { background:#fff; color:var(--brand-accent); font-weight:800; font-size:.78rem; letter-spacing:.4px; padding:.55rem .95rem .6rem; border-radius:1rem; display:inline-flex; align-items:center; gap:.4rem; box-shadow:0 6px 12px -6px rgba(0,0,0,.4); transition:transform .3s ease, box-shadow .3s ease; }
    #roulette-promo-toast button.promo-spin:hover { transform:translateY(-2px); box-shadow:0 10px 22px -8px rgba(0,0,0,.5); }
    #roulette-promo-toast button.close-toast { position:absolute; top:6px; right:8px; background:rgba(255,255,255,.15); width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:.95rem; font-weight:600; backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); transition:background .3s ease; }
    #roulette-promo-toast button.close-toast:hover { background:rgba(255,255,255,.3); }
    /* Móvil: más compacto */
    @media (max-width:640px){
        #roulette-promo-toast { padding:.8rem .9rem .9rem; border-radius:1.1rem; gap:.6rem; width:calc(100% - 1.2rem); }
        #roulette-promo-toast .icon-wrap{ width:42px; height:42px; border-radius:.9rem; }
        #roulette-promo-toast h4{font-size:.95rem;}
    #roulette-promo-toast p{ font-size:.75rem; margin-bottom:.5rem; white-space:normal; word-break:break-word; hyphens:auto; }
        #roulette-promo-toast button.promo-spin{ font-size:.75rem; padding:.5rem .85rem .55rem; border-radius:.9rem; }
    }

    /* Estado compacto automático */
    #roulette-promo-toast.compact{ padding:.55rem .7rem; border-radius:1rem; align-items:center; gap:.55rem; }
    #roulette-promo-toast.compact .icon-wrap{ width:36px; height:36px; border-radius:.8rem; }
    #roulette-promo-toast.compact h4{ font-size:.9rem; margin:0; }
    #roulette-promo-toast.compact p{ display:none; }
    #roulette-promo-toast.compact .inline-flex{ transform:scale(.95); transform-origin:left center; }
    #roulette-promo-toast.compact button.promo-spin{ padding:.45rem .75rem .5rem; font-size:.72rem; }

    /* Flecha guía redes */
    .social-arrow-hint{position:fixed; left:1.1rem; bottom:4.8rem; z-index:4800; display:flex; flex-direction:column; align-items:flex-start; font-size:.65rem; font-weight:700; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.45); pointer-events:none;}
    .social-arrow-hint .bubble{background:linear-gradient(135deg,#25D366,#079b54); padding:.55rem .7rem; border-radius:1rem; margin-bottom:.4rem; box-shadow:0 8px 24px -10px rgba(0,0,0,.55); animation:hintPop 6s ease-in-out infinite; letter-spacing:.5px;}
    .social-arrow-hint svg{width:44px; height:44px; stroke:#25D366; filter:drop-shadow(0 4px 10px rgba(0,0,0,.5)); animation:arrowPulse 1.8s ease-in-out infinite;}
    @keyframes arrowPulse{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);} }
    @keyframes hintPop{0%,100%{transform:scale(1);}50%{transform:scale(1.07);} }

    /* === POPUPS PROMOCIONALES Dinámicos === */
    .fi-promo-popup{position:fixed;max-width:340px;width:calc(100% - 2rem);border-radius:1.75rem;background:linear-gradient(145deg,var(--brand-accent),var(--brand-primary,#ff5fa3));box-shadow:0 20px 40px -15px rgba(0,0,0,.55),0 8px 20px -10px rgba(0,0,0,.4);z-index:5000;overflow:hidden;
        --border-light:rgba(255,255,255,.3);--border-heavy:rgba(255,255,255,.08);}
    .fi-promo-popup:before{content:"";position:absolute;inset:0;padding:2px;border-radius:inherit;background:linear-gradient(140deg,rgba(255,255,255,.7),rgba(255,255,255,0) 35%,rgba(255,255,255,.35) 70%,rgba(255,255,255,0));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.55;pointer-events:none;}
    .fi-promo-popup .shimmer{content:"";position:absolute;top:0;left:-40%;width:40%;height:100%;background:linear-gradient(120deg,transparent,rgba(255,255,255,.55),transparent);filter:blur(4px);transform:skewX(-20deg);animation:shimmerSlide 6s ease-in-out infinite;pointer-events:none;mix-blend-mode:overlay;}
    @keyframes shimmerSlide{0%{left:-45%;opacity:0}15%{opacity:1}50%{left:110%;opacity:1}60%{opacity:0}100%{left:110%;opacity:0}}
    .fi-promo-popup .floaty{animation:floatPromo 7s ease-in-out infinite;}
    @keyframes floatPromo{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .fi-promo-popup .pulse-ring{position:absolute;inset:0;border-radius:inherit;pointer-events:none;animation:pulseRing 5.8s ease-in-out infinite;}
    @keyframes pulseRing{0%{box-shadow:0 0 0 0 rgba(255,255,255,.35)}60%{box-shadow:0 0 0 18px rgba(255,255,255,0)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}
    .fi-promo-popup .img-wrap{position:relative;overflow:hidden;border-radius:1.1rem;}
    .fi-promo-popup .img-wrap:after{content:"";position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.45),rgba(255,255,255,0) 70%);mix-blend-mode:overlay;opacity:.65;}

    </style>
    {% block extra_css %}{% endblock %}
</head>
<body data-cart-count-url="{% url 'cart_count' %}" class="flex flex-col min-h-screen {% block body_class %}{% endblock %}" {% if ruleta_activa %}x-data="rouletteGame()" x-init="init()"{% endif %}>

    <!-- Encabezado y Menú Móvil -->
    {% include 'partials/_header.html' %}

    <!-- Migas de Pan (ocultas en páginas tipo catálogo mediante body_class) -->
    <div class="breadcrumbs-bar bg-white/50 border-b border-gray-200">
        <div class="container mx-auto px-4 sm:px-8 py-3">
            {% block breadcrumbs %}{% endblock %}
        </div>
    </div>

    <!-- Contenido Principal de la Página -->
    <main class="flex-grow">
        {% block content %}
        {% endblock %}
    </main>
    
    <!-- Pie de Página y Elementos Flotantes -->
    {% include 'partials/_footer.html' %}

    {% if ruleta_activa %}
    <!-- Botón Ruleta Desktop flotante (independiente del header) -->
    <button @click="openRoulette && openRoulette()" id="roulette-fab" class="hidden md:flex premium-spin-btn fixed bottom-6 right-24 w-16 h-16 rounded-full items-center justify-center text-white focus:outline-none focus-visible:ring-4 focus-visible:ring-pink-300/60 z-50" aria-label="Abrir Ruleta">
        <div class="roulette-inner">
            <i class="fas fa-dice fa-lg drop-shadow-md"></i>
            <span class="roulette-tooltip">Gira y gana</span>
        </div>
        <span class="spark spark-1"></span>
        <span class="spark spark-2"></span>
        <span class="spark spark-3"></span>
    </button>
    {% endif %}

    <!-- Ruleta de la Suerte (modales y lógica) -->
    {% if ruleta_activa %}
        <!-- Modal de la Ruleta (para usuarios logueados) -->
    <div x-show="isOpen" x-cloak x-transition class="roulette-modal-overlay fixed inset-0 bg-black/60 flex items-center justify-center p-4">
            <div @click.away="isOpen = false" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                <h2 class="text-3xl font-brand text-[--brand-brown] mb-2" x-text="config.titulo || 'Gira la Ruleta'"></h2>
                <template x-if="config.remaining_seconds && config.remaining_seconds > 0">
                    <div class="mb-3" aria-live="polite">
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-lg" style="background:#fff; color: var(--brand-accent); border:1px solid rgba(236,72,153,.35);">
                            <i class="fas fa-hourglass-half"></i>
                            <span class="font-bold tabular-nums" x-text="formatCountdown(config.remaining_seconds)"></span>
                        </div>
                        <div class="w-full h-1.5 rounded mt-2" style="background: rgba(236,72,153,.15);">
                            <div class="h-full rounded" :style="{ width: progressPercent() + '%', background: 'linear-gradient(90deg, var(--brand-accent), var(--brand-primary,#f9a8d4))' }"></div>
                        </div>
                    </div>
                </template>
                <p class="text-gray-500 mb-6" x-text="message"></p>
                <div class="relative w-64 h-64 mx-auto mb-6">
                    <div id="roulette-wheel" class="absolute w-full h-full rounded-full border-8" style="border-color: rgba(var(--brand-primary-rgb, 249,168,212),0.6);" :style="{ background: wheelStyle }">
                        <!-- === INICIO DE LA MEJORA: HTML para el Texto de la Ruleta === -->
                        <template x-for="(prize, index) in prizes" :key="index">
                            <div class="prize-text" :style="prizeStyle(index)" x-html="formatPrize(prize, index)"></div>
                        </template>
                        <!-- === FIN DE LA MEJORA === -->
                        <!-- (SVG curvo desactivado) -->
                        <svg id="roulette-svg" style="display:none" class="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 1000 1000"></svg>
                        <div class="roulette-center-shadow"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="roulette-hub-label w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-white/90 backdrop-blur font-extrabold text-[--brand-accent] flex items-center justify-center ring-2 ring-pink-300 shadow-inner select-none">FI</div>
                        </div>
                    </div>
                    <!-- Nuevo puntero elegante -->
                    <div class="roulette-pointer elegant-pointer absolute -top-6 left-1/2 -translate-x-1/2 w-10 h-14 flex items-end justify-center select-none" aria-hidden="true">
                        <svg viewBox="0 0 60 90" class="w-full h-full overflow-visible">
                            <defs>
                                <linearGradient id="ptrGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" stop-color="var(--brand-accent)" stop-opacity="1" />
                                    <stop offset="55%" stop-color="var(--brand-primary,#f9a8d4)" stop-opacity="1" />
                                    <stop offset="100%" stop-color="var(--brand-accent)" stop-opacity="1" />
                                </linearGradient>
                                <radialGradient id="ptrShine" cx="50%" cy="30%" r="70%">
                                    <stop offset="0%" stop-color="#fff" stop-opacity="0.9" />
                                    <stop offset="45%" stop-color="#fff" stop-opacity="0.15" />
                                    <stop offset="100%" stop-color="#fff" stop-opacity="0" />
                                </radialGradient>
                                <filter id="ptrGlow" x="-40%" y="-40%" width="180%" height="180%">
                                    <feGaussianBlur in="SourceGraphic" stdDeviation="2.2" result="blur" />
                                    <feMerge>
                                        <feMergeNode in="blur" />
                                        <feMergeNode in="SourceGraphic" />
                                    </feMerge>
                                </filter>
                            </defs>
                            <!-- Base circular -->
                            <circle cx="30" cy="54" r="20" fill="url(#ptrGrad)" stroke="rgba(255,255,255,0.7)" stroke-width="2" filter="url(#ptrGlow)" />
                            <circle cx="30" cy="54" r="14" fill="rgba(255,255,255,0.9)" stroke="rgba(255,255,255,0.9)" stroke-width="1" />
                            <!-- Cuerpo / aguja -->
                            <path d="M30 4 L48 50 Q30 42 12 50 Z" fill="url(#ptrGrad)" stroke="rgba(255,255,255,0.85)" stroke-width="2" />
                            <path d="M30 8 L42 48 Q30 44 18 48 Z" fill="url(#ptrShine)" />
                            <!-- Brillo especular fino -->
                            <path d="M30 6 L44 48" stroke="rgba(255,255,255,0.55)" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </div>
                </div>
                <button @click="spin()" :disabled="isSpinning || (hasPlayed && !isAdmin)" class="w-full text-white font-bold py-3 px-6 rounded-full text-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" :style="{ backgroundColor: 'var(--brand-accent)' }">
                    <span x-show="!isSpinning && !(hasPlayed && !isAdmin)">¡GIRAR AHORA!</span>
                    <span x-show="isSpinning"><i class="fas fa-spinner fa-spin mr-2"></i> Girando...</span>
                    <span x-show="hasPlayed && !isAdmin">Intentos agotados</span>
                </button>
                <div aria-live="polite" class="sr-only" x-text="prizeResult ? 'Has ganado ' + (prizeResult.name || prizeResult.nombre) : ''"></div>
                <div x-show="prizeResult" x-transition class="mt-6">
                    <p class="text-lg">¡Felicidades! Has ganado:</p>
                    <p class="text-2xl font-bold my-2" x-text="prizeResult ? prizeResult.name : ''" :style="{ color: 'var(--brand-accent)' }"></p>
                    <a :href="whatsappLink" target="_blank" class="inline-flex items-center justify-center bg-green-500 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 mt-2">
                        <i class="fab fa-whatsapp mr-3"></i> Reclamar Premio por WhatsApp
                    </a>
                </div>
            </div>
        </div>

    <!-- Modal "Inicia Sesión" para invitados -->
    <div x-show="showLoginModal" x-cloak x-transition class="roulette-modal-overlay fixed inset-0 bg-black/60 flex items-center justify-center p-4">
            <div @click.away="showLoginModal = false" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                <div class="text-pink-500 text-5xl mb-4">
                    <i class="fas fa-lock"></i>
                </div>
                <h2 class="text-3xl font-bold text-[--brand-brown] mb-2">¡Un Momento!</h2>
                <p class="text-gray-600 mb-6">Para poder girar la ruleta y ganar premios exclusivos, necesitas una cuenta.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <a href="{% url 'login' %}?next={{ request.path }}" class="w-full bg-[--brand-accent] text-white font-bold py-3 px-6 rounded-full transition-transform hover:scale-105">Iniciar Sesión</a>
                    <a href="{% url 'registro' %}?next={{ request.path }}" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-full transition-transform hover:scale-105">Registrarse</a>
                </div>
            </div>
    </div>
    {% endif %}

    <div id="big-win-text" aria-hidden="true">¡GANASTE!</div>
    {% if ruleta_activa %}
    <div id="roulette-promo-toast" x-data="{}" x-cloak aria-live="polite" aria-atomic="true">
        <button class="close-toast" type="button" aria-label="Cerrar" onclick="hideRoulettePromo()">&times;</button>
        <div class="icon-wrap">
            <i class="fas fa-dice fa-lg text-[--brand-accent]"></i>
        </div>
        <div class="flex-1 min-w-0">
            <h4>¡Premios hoy!</h4>
            <p>Gira la ruleta y gana descuentos o regalos exclusivos. Tienes hasta <strong>3 intentos</strong> mientras la promoción esté activa.</p>
            <!-- Contador de urgencia para el toast -->
            <div class="mt-1" aria-live="polite">
                <div class="inline-flex items-center gap-2 px-2.5 py-0.5 rounded-md"
                     style="background:#fff; color: var(--brand-accent); border:1px solid rgba(255,255,255,.35);">
                    <i class="fas fa-hourglass-half" aria-hidden="true"></i>
                    <span id="roulette-countdown-text" class="font-bold tabular-nums">Termina en --:--:--</span>
                </div>
                <div class="w-full h-1.5 rounded mt-2" style="background: rgba(255,255,255,.35);">
                    <div id="roulette-countdown-progress" class="h-full rounded" style="width:100%; background:#fff;"></div>
                </div>
            </div>
            <button class="promo-spin" type="button" onclick="openRouletteFromPromo()"><i class="fas fa-bolt"></i> GIRAR</button>
        </div>
    </div>
    {% endif %}

    {% if configuracion_sitio.whatsapp_link %}
    <div id="social-arrow-hint" class="social-arrow-hint" aria-hidden="true" style="display:none;">
        <div class="bubble">¿Duda rápida? Escríbenos</div>
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18" stroke="currentColor"/><path d="M5 12l7 9 7-9" stroke="currentColor"/></svg>
    </div>
    {% endif %}

    <!-- Contenedor global para popups de promoción -->
    <div id="promo-popups-root" aria-live="polite" aria-atomic="true" style="position:relative;z-index:5000;pointer-events:none;"></div>

    {% include 'partials/_scripts.html' %}
    
    {% block extra_js %}{% endblock %}
    <script src="//unpkg.com/alpinejs" defer></script>
    {% if ruleta_activa %}
    <script>
    (function(){
    // --- Identificador de usuario para aislar claves LS por cuenta ---
    const USER_ID = '{% if request.user.is_authenticated %}u{{ request.user.id }}{% else %}anon{% endif %}';
    function userKey(base){ return base + '::' + USER_ID; }
    const IS_MOBILE = window.matchMedia('(max-width: 768px)').matches;
    let userClosedToast = false;
    const SESSION_SHOWN_KEY = userKey('rouletteToastShownSession');
    // Control por intentos totales (máx 3) mientras la promo esté activa
    const MAX_TOTAL_ATTEMPTS = 3;
    function getTotalAttempts(){
        try { return parseInt(localStorage.getItem(userKey('fiRouletteAttemptsTotal'))||'0',10)||0; } catch(e){ return 0; }
    }
    function shouldShow(){
        if(getTotalAttempts() >= MAX_TOTAL_ATTEMPTS) return false;
        if(sessionStorage.getItem(SESSION_SHOWN_KEY)==='1') return false;
        return true;
    }
        window.hideRoulettePromo = function(){
            const t = document.getElementById('roulette-promo-toast');
            if(!t) return;
            userClosedToast = true; t.classList.remove('show'); t.classList.add('hide');
        }
        let promoExpired = false;
        window.openRouletteFromPromo = function(){
            if(promoExpired){ return; }
            hideRoulettePromo();
            // Disparar apertura ruleta (desktop FAB o mobile button)
            const alpineRoot = document.querySelector('[x-data*="rouletteGame"]');
            if(alpineRoot){
                // Intentar acceder a la instancia Alpine
                try {
                    const comp = Alpine && Alpine.$data(alpineRoot);
                    if(comp){
                        if(!comp.isOpen){ comp.openRoulette ? comp.openRoulette() : (comp.isOpen = true); }
                    }
                } catch(e){}
            }
            // Foco accesible
            setTimeout(()=>{
                const btn = document.querySelector('#roulette-fab, #roulette-fab-mobile');
                if(btn) btn.focus({preventScroll:true});
            }, 50);
        }
        document.addEventListener('DOMContentLoaded', function(){
            const t = document.getElementById('roulette-promo-toast');
            if(!t) return;
            // Inicializar contador de urgencia del toast
            const textEl = document.getElementById('roulette-countdown-text');
            const progEl = document.getElementById('roulette-countdown-progress');
            const spinBtn = t.querySelector('button.promo-spin');
            let remaining = null; // null => sin fecha fin, no expira automáticamente
            let totalMs = null;
            try {
                const cfg = {{ roulette_config_json|safe }};
                if(cfg && typeof cfg.remaining_seconds === 'number'){
                    remaining = Math.max(0, cfg.remaining_seconds|0);
                } else {
                    remaining = null;
                }
                const fin = cfg && cfg.fecha_fin ? Date.parse(cfg.fecha_fin) : null;
                const ini = cfg && cfg.fecha_inicio ? Date.parse(cfg.fecha_inicio) : null;
                if(fin && ini && fin>ini){ totalMs = fin - ini; }
            } catch(e) {}
            function pad(n){ return String(n).padStart(2,'0'); }
            function formatCountdown(sec){
                if(sec === null) return 'Disponible';
                if(!sec || sec<=0) return 'Finalizó';
                let r = sec;
                const d = Math.floor(r/86400); r%=86400;
                const h = Math.floor(r/3600); r%=3600; const m = Math.floor(r/60); const s = r%60;
                const hTot = d*24 + h;
                return 'Termina en ' + pad(hTot)+':'+pad(m)+':'+pad(s);
            }
            function updateCountdown(){
                if(textEl){ textEl.textContent = formatCountdown(remaining); }
                if(progEl){
                    let pct = 100;
                    if(remaining !== null){
                        if(totalMs){ pct = Math.max(0, Math.min(100, Math.round((remaining*1000/totalMs)*100))); }
                        else { pct = Math.max(0, Math.min(100, Math.round((remaining/(24*3600))*100))); }
                    }
                    progEl.style.width = pct + '%';
                }
                if(remaining !== null && remaining<=0){
                    promoExpired = true;
                    if(spinBtn){ spinBtn.disabled = true; spinBtn.style.opacity = '.6'; spinBtn.style.cursor='not-allowed'; spinBtn.innerHTML = '<i class="fas fa-flag-checkered"></i> FINALIZÓ'; }
                    hideRoulettePromo();
                    return false;
                }
                return true;
            }
            if(remaining !== null && remaining>0){
                updateCountdown();
                const iv = setInterval(()=>{ remaining -= 1; if(!updateCountdown()){ clearInterval(iv); } }, 1000);
            } else {
                // Sin fecha fin: no expira automáticamente
                promoExpired = false;
                updateCountdown();
            }
            if(shouldShow()){
                setTimeout(()=>{ if(!promoExpired){ t.classList.add('show'); sessionStorage.setItem(SESSION_SHOWN_KEY,'1'); } }, 650);
            }
            // Auto-compactar en móvil al hacer scroll
            const isMobile = window.matchMedia('(max-width: 640px)').matches;
            if(isMobile){
                let lastY = window.scrollY;
                const onScroll = ()=>{
                    const cur = window.scrollY; const delta = cur - lastY; lastY = cur;
                    if(delta > 4){ t.classList.add('compact'); } else if(delta < -4){ t.classList.remove('compact'); }
                };
                window.addEventListener('scroll', onScroll, {passive:true});
                // Swipe para cerrar
                let startY=null; let moved=false;
                t.addEventListener('touchstart', e=>{ startY = e.touches[0].clientY; moved=false; }, {passive:true});
                t.addEventListener('touchmove', e=>{
                    if(startY==null) return; const diff = e.touches[0].clientY - startY; if(diff>14){ moved=true; t.style.transform = `translate(-50%, ${Math.min(60,diff)}px)`; }
                }, {passive:true});
                t.addEventListener('touchend', ()=>{
                    if(moved){ hideRoulettePromo(); setTimeout(()=>{ t.style.transform='translateX(-50%)'; }, 400); }
                    startY=null; moved=false;
                });
            }
        });
    })();
    </script>
    {% endif %}
    <script>
    // Hint flecha hacia botón social existente (solo 1 vez por día)
    (function(){
        const HINT_KEY='fiSocialHintDate';
        const today = new Date().toISOString().split('T')[0];
        if(localStorage.getItem(HINT_KEY) === today) return; // ya mostrado hoy
        const hint = document.getElementById('social-arrow-hint');
        const socialBtn = document.querySelector('.social-icon, .btn-redes, [data-social-launch]');
        let hiddenForSession = false;
        let interacted=false;
        function showHint(){ if(!hint || !socialBtn || hiddenForSession || interacted) return; hint.style.display='flex'; position(); localStorage.setItem(HINT_KEY, today); setTimeout(()=>hideHint(), 10000); }
        function hideHint(){ if(!hint) return; hint.style.opacity='0'; setTimeout(()=>{ hint.style.display='none'; },500); hiddenForSession=true; }
        function position(){ if(!hint || !socialBtn) return; const r = socialBtn.getBoundingClientRect(); hint.style.left = (r.left + 4) + 'px'; hint.style.bottom = (window.innerHeight - r.top) + 52 + 'px'; }
        window.addEventListener('resize', position);
        ['click','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,()=>{interacted=true;} ,{once:true}));
        document.addEventListener('DOMContentLoaded', ()=> setTimeout(showHint, 4200));
    })();
    </script>
    <script>
    // === POPUPS PROMOCIONALES (Entrada, Salida, Navegación, Inactividad, Logout) ===
    (function(){
        const data = (()=>{ try { return JSON.parse('{{ promo_products_json|escapejs }}') } catch(e){ return {}; } })();
        const root = document.getElementById('promo-popups-root');
        if(!root) return;
    const shownFlags = { entry:false, exit:false, logout:false };
    let lastProductId = null;
    let shownTotal = 0;
    let lastShowTime = 0;
    let lastActivity = Date.now();
    const promoConfig = { cooldownMs: 30000, maxShows: Infinity }; // 30s, ilimitado mientras permanezca
    const initialCartCount = {{ cart_count|default:0 }};
        function buildCard(type, prod){
            if(type==='contact'){
                return `<a href="{{ configuracion_sitio.whatsapp_link|default:'#' }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-[13px] sm:text-[14px] font-extrabold text-green-700 whitespace-nowrap">
                    <i class='fab fa-whatsapp text-[18px]'></i>
                    <span>Escribir por WhatsApp</span>
                </a>`;
            }
            if(!prod) return '';
            // Tomar hasta 2 imágenes (variantes) si existen
            const extractImages = (p)=>{
                const out=[];
                if(Array.isArray(p?.variant_images)) out.push(...p.variant_images.filter(Boolean));
                if(Array.isArray(p?.images)) out.push(...p.images.filter(Boolean));
                if(Array.isArray(p?.variantes)) out.push(...p.variantes.map(v=>v?.image||v?.imagen||v?.url).filter(Boolean));
                if(p?.image) out.push(p.image);
                // eliminar duplicados conservando orden
                return Array.from(new Set(out)).slice(0,2);
            };
            const imgs = extractImages(prod);
            const discount = prod.discount_percent ? `<span class="text-xs font-bold bg-white/90 text-pink-600 px-2 py-1 rounded-full ml-2 shadow">-${prod.discount_percent}%</span>` : '';
            const price = prod.offer_price ? `<span class='line-through opacity-70 mr-2'>S/ ${prod.price}</span><span class='text-white font-bold'>S/ ${prod.offer_price}</span>` : `<span class='text-white font-bold'>S/ ${prod.price}</span>`;
            const label = type==='new' ? 'Nueva Colección' : 'Oferta Especial';
            const badgeColor = type==='new'? 'from-pink-500 to-rose-500':'from-amber-400 to-pink-500';
            return `<div class="promo-card flex gap-3">
                ${imgs.length ? `
                <div class="flex-shrink-0 self-center">
                    ${imgs.length>1 ? `
                    <div class='flex gap-2'>
                        <div class="w-20 h-20 sm:w-24 sm:h-24 rounded-xl overflow-hidden ring-2 ring-white/40 bg-pink-100"><img src='${imgs[0]}' alt='${prod.name}' class='w-full h-full object-cover'></div>
                        <div class="w-20 h-20 sm:w-24 sm:h-24 rounded-xl overflow-hidden ring-2 ring-white/40 bg-pink-100"><img src='${imgs[1]}' alt='${prod.name}' class='w-full h-full object-cover'></div>
                    </div>
                    ` : `
                    <div class="w-40 h-40 sm:w-44 sm:h-44 rounded-xl overflow-hidden ring-2 ring-white/40 bg-pink-100"><img src='${imgs[0]}' alt='${prod.name}' class='w-full h-full object-cover'></div>
                    `}
                </div>
                ` : ''}
                <div class="flex-1 min-w-0">
                    <div class="inline-flex items-center text-[10px] uppercase tracking-wider font-bold bg-gradient-to-r ${badgeColor} text-white px-2 py-1 rounded-full shadow mb-1">${label}${discount}</div>
                    <h4 class="text-sm font-extrabold text-white leading-tight mb-1">${prod.name}</h4>
                    <div class="text-[13px] mb-2 text-white/90 flex items-center flex-wrap">${price}</div>
                    <a href="/producto/${prod.id}/" class="inline-flex items-center gap-1 text-[11px] font-bold bg-white text-pink-600 px-3 py-2 rounded-full shadow hover:scale-105 transition">Ver ahora <i class='fas fa-arrow-right text-[10px]'></i></a>
                </div>
            </div>`;
        }
    const POSITIONS = ['top-left','top-right','bottom-left','bottom-right','center'];
        let lastPos = null;
        function pickPosition(){
            let p = POSITIONS[Math.floor(Math.random()*POSITIONS.length)];
            if(lastPos && POSITIONS.length>1){
                let tries=0; while(p===lastPos && tries<4){ p = POSITIONS[Math.floor(Math.random()*POSITIONS.length)]; tries++; }
            }
            lastPos = p; return p;
        }
        function popupTemplate(id, inner){
            const pos = pickPosition();
            const margin = 12; // px desde borde
            let style=""; let origin="center"; let entry="";
            if(pos==='top-left'){ style = `top:${margin+64}px; left:${margin}px;`; origin='top left'; entry='translate(-18px,-14px) scale(.85) rotate(-6deg)'; }
            if(pos==='top-right'){ style = `top:${margin+64}px; right:${margin}px;`; origin='top right'; entry='translate(18px,-14px) scale(.85) rotate(6deg)'; }
            if(pos==='bottom-left'){ style = `bottom:${margin+96}px; left:${margin}px;`; origin='bottom left'; entry='translate(-18px,18px) scale(.85) rotate(4deg)'; }
            if(pos==='bottom-right'){ style = `bottom:${margin+96}px; right:${margin}px;`; origin='bottom right'; entry='translate(18px,18px) scale(.85) rotate(-4deg)'; }
            if(pos==='center'){ style = `top:50%; left:50%;`; origin='center'; entry='translate(-50%,-50%) scale(.8) rotate(-2deg)'; }
            return `<div id='${id}' data-pos='${pos}' class="fi-promo-popup group pointer-events-auto select-none overflow-hidden backdrop-blur-sm bg-gradient-to-br from-pink-600 via-rose-600 to-fuchsia-600 text-white shadow-[0_18px_48px_-12px_rgba(0,0,0,.55)] border border-white/15 ring-1 ring-white/10" style="${style} opacity:0; transform:${entry}; transform-origin:${origin}; z-index:9999;">
                <div class='pulse-ring' style="pointer-events:none;"></div><div class='shimmer' style="pointer-events:none;"></div>
                <button type='button' aria-label='Cerrar' data-close class='fi-promo-close absolute top-1.5 right-1.5 w-8 h-8 rounded-full bg-white/25 hover:bg-white/40 flex items-center justify-center text-white text-base font-bold backdrop-blur-sm transition focus:outline-none focus:ring-2 focus:ring-white/70' style="z-index:20;">×</button>
                <div class='pr-2'>${inner}</div>
            </div>`;
        }
        // Variante pill para WhatsApp (sin tarjeta grande)
        function contactPopupTemplate(id, inner){
            const pos = pickPosition();
            const margin = 12;
            let style=""; let origin="center"; let entry="";
            if(pos==='top-left'){ style = `top:${margin+64}px; left:${margin}px;`; origin='top left'; entry='translate(-12px,-10px) scale(.9)'; }
            if(pos==='top-right'){ style = `top:${margin+64}px; right:${margin}px;`; origin='top right'; entry='translate(12px,-10px) scale(.9)'; }
            if(pos==='bottom-left'){ style = `bottom:${margin+96}px; left:${margin}px;`; origin='bottom left'; entry='translate(-12px,12px) scale(.9)'; }
            if(pos==='bottom-right'){ style = `bottom:${margin+96}px; right:${margin}px;`; origin='bottom right'; entry='translate(12px,12px) scale(.9)'; }
            if(pos==='center'){ style = `top:50%; left:50%;`; origin='center'; entry='translate(-50%,-50%) scale(.9)'; }
            return `<div id='${id}' data-pos='${pos}' class="fi-promo-popup pointer-events-auto select-none" style="${style} opacity:0; transform:${entry}; transform-origin:${origin}; z-index:9999; background:transparent; box-shadow:none; border:none; width:auto; max-width:none;">
                <button type='button' aria-label='Cerrar' data-close class='absolute -top-2 -right-2 w-7 h-7 rounded-full bg-black/40 hover:bg-black/55 text-white flex items-center justify-center text-sm font-bold shadow' style="z-index:20;">×</button>
                <div class="inline-flex bg-white rounded-full px-5 py-2 shadow-xl border-2 border-emerald-400/80 text-green-700">
                    ${inner}
                </div>
            </div>`;
        }
        function pickRandomProduct(){
            const pool = [data.offer, data.new_collection, data.any_product].filter(Boolean);
            if(!pool.length) return null;
            if(pool.length === 1) return pool[0];
            let choice=null; let attempts=0;
            while(attempts < 5){
                choice = pool[Math.floor(Math.random()*pool.length)];
                if(!lastProductId || choice.id !== lastProductId) break;
                attempts++;
            }
            return choice;
        }
        function isToastVisible(){
            const t=document.getElementById('roulette-promo-toast');
            return !!(t && t.classList.contains('show'));
        }
        function adjustForToast(el){
            if(!el) return;
            if(!isToastVisible()) return;
            const pos = el.dataset.pos;
            // Popups flotantes en esquinas
            if(pos==='bottom-left' || pos==='bottom-right'){
                const t=document.getElementById('roulette-promo-toast');
                const h = t ? t.getBoundingClientRect().height : 0;
                // Separación extra para respirar
                el.style.bottom = (h + 28) + 'px';
            }
            
        }
        function canShow(){
            const now = Date.now();
            if(shownTotal >= promoConfig.maxShows) return false; // Infinity => nunca corta por contador
            if(now - lastShowTime < promoConfig.cooldownMs) return false;
            return true;
        }
        // Persistencia sesión (version + reseteo diario)
    // Clave por usuario para no bloquear nuevas cuentas con el histórico de otro
    const USER_ID_PROMO = '{% if request.user.is_authenticated %}u{{ request.user.id }}{% else %}anon{% endif %}';
    const LS_KEY_BASE='fiPromoSessionV2';
    const LS_KEY=LS_KEY_BASE+'::'+USER_ID_PROMO;
        const todayStr = new Date().toISOString().split('T')[0];
        function loadSession(){
            try{ const obj = JSON.parse(localStorage.getItem(LS_KEY)); if(!obj||obj.day!==todayStr){ return {day:todayStr, shown:{}, count:0,last:0}; } return obj; }catch(e){ return {day:todayStr,shown:{},count:0,last:0}; }
        }
        function saveSession(s){ try{ localStorage.setItem(LS_KEY, JSON.stringify(s)); }catch(e){} }
        let promoSession = loadSession();
    const DEBUG_PROMO = true; if(DEBUG_PROMO) console.log('[PROMO] Session:', LS_KEY, promoSession, data);
    // Helper para pruebas manuales
    window.resetPromoSessionForUser = function(){ try{ localStorage.removeItem(LS_KEY); promoSession = loadSession(); console.log('[PROMO] reset hecho', LS_KEY, promoSession); }catch(e){} };
        function showPopup(kind, forcedType=null, opts={}){
            const ignoreCooldown = !!opts.ignoreCooldown;
            const dontCount = !!opts.dontCount; // si true no suma al contador
            // En modo infinito ignoramos persistencias previas: no early returns por shownFlags o session
            if(!ignoreCooldown && !canShow()) { if(DEBUG_PROMO) console.log('[PROMO] cooldown'); return; }
            // Asegurar un solo popup (elimina anteriores no persistentes)
            try { document.querySelectorAll('.fi-promo-popup').forEach(p=>{ if(!p.dataset.persist) p.remove(); }); } catch(e){}
            let type; let prod=null;
            if(forcedType==='contact'){
                type='contact';
            } else {
                prod = pickRandomProduct();
                if(!prod){
                    // Fallback a contacto si no hay data de productos
                    type='contact';
                    if(DEBUG_PROMO) console.warn('[PROMO] No hay producto disponible, usando contacto');
                } else {
                    type = prod === data.new_collection ? 'new' : (prod === data.offer ? 'offer' : 'offer');
                }
            }
            // No marcamos kind como bloqueado; sólo stats ligeras
            if(!dontCount){ shownTotal++; }
            lastShowTime = Date.now();
            const id='fi-popup-'+kind;
            const inner = buildCard(type, prod);
            const html = (type==='contact') ? contactPopupTemplate(id, inner) : popupTemplate(id, inner);
            root.insertAdjacentHTML('beforeend', html);
            if(DEBUG_PROMO) console.log('[PROMO] mostrado', kind, type, prod);
            requestAnimationFrame(()=>{
                const el=document.getElementById(id); if(!el) return; const pos = el.dataset.pos; const base = pos==='center' ? 'translate(-50%,-50%)' : 'translate(0,0)';
                adjustForToast(el);
                el.style.transition='opacity .8s cubic-bezier(.19,1,.22,1), transform .9s cubic-bezier(.19,1,.22,1)'; el.style.opacity='1'; el.style.transform=`${base} scale(1) rotate(0deg)`;
                // micro animación hover group (manteniendo centro si aplica)
                el.addEventListener('mouseenter',()=>{ el.style.transitionDuration='.45s'; el.style.transform=`${base} scale(1.05)`; });
                el.addEventListener('mouseleave',()=>{ el.style.transform=`${base} scale(1)`; });
                el.querySelector('[data-close]')?.addEventListener('click', ()=>hide(el));
                setTimeout(()=>hide(el), 9000);
            });
        }
    function hide(el){ if(!el) return; const pos=el.dataset.pos; const base = pos==='center' ? 'translate(-50%,-50%)' : 'translate(0,0)'; el.style.transition='opacity .5s ease, transform .55s cubic-bezier(.55,.01,.58,.99)'; el.style.opacity='0'; el.style.transform=`${base} translateY(12px) scale(.85)`; setTimeout(()=>el.remove(),520); }
        // Secuencia (cada 30s): entry -> contact -> final, sólo los no mostrados previamente (persistencia LS)
        window.addEventListener('load', ()=>{
            const baseSeq=[{k:'entry', forced:null},{k:'contact', forced:'contact'},{k:'final', forced:null}];
            const LS_LAST_ABS='fiPromoLastShownAbs';
            const LS_IDX='fiPromoSeqIdx';
            const interval = promoConfig.cooldownMs; // 30000 ms
            let nextPlannedTs = 0; // timestamp del próximo popup programado
            let seqIdx = parseInt(localStorage.getItem(LS_IDX)||'0',10) || 0;
            function nextKind(){ const item = baseSeq[seqIdx % baseSeq.length]; seqIdx++; try{localStorage.setItem(LS_IDX, String(seqIdx));}catch(e){} return item; }
            function doShow(){
                const item = nextKind();
                showPopup(item.k, item.forced, {ignoreCooldown:true});
                try{ localStorage.setItem(LS_LAST_ABS, Date.now().toString()); }catch(e){}
                nextPlannedTs = Date.now() + interval;
                schedule();
            }
            function schedule(){
                const lastTs = parseInt(localStorage.getItem(LS_LAST_ABS)||'0',10);
                const now = Date.now();
                if(!nextPlannedTs){
                    nextPlannedTs = lastTs ? (lastTs + interval) : now; // si no hay histórico dispara rápido
                }
                let remaining = Math.max(0, nextPlannedTs - now);
                if(DEBUG_PROMO) console.log('[PROMO] schedule remaining', remaining, 'nextPlannedTs', nextPlannedTs);
                clearTimeout(schedule._t);
                schedule._t = setTimeout(doShow, remaining);
                schedule._remaining = null; // limpiamos estado de pausa
            }
            // Si nunca se mostró, simular que fue hace (interval) para disparar rápido tras breve gracia
            if(!localStorage.getItem(LS_LAST_ABS)){
                try{ localStorage.setItem(LS_LAST_ABS, (Date.now()-interval).toString()); }catch(e){}
            }
            // Pequeño retraso inicial suave (1s) para no irrumpir al milisegundo
            setTimeout(schedule, 1000);
            // Pausa / reanuda en cambio de visibilidad (evita ráfaga tras volver)
            document.addEventListener('visibilitychange', ()=>{
                if(document.hidden){
                    if(schedule._t){
                        clearTimeout(schedule._t);
                        schedule._t = null;
                        const rem = Math.max(0, nextPlannedTs - Date.now());
                        schedule._remaining = rem;
                        if(DEBUG_PROMO) console.log('[PROMO] pausa, remaining', rem);
                    }
                } else {
                    if(schedule._remaining != null){
                        let rem = schedule._remaining;
                        // Evita disparo instantáneo (sensación brusca)
                        if(rem < 800) rem = 800;
                        nextPlannedTs = Date.now() + rem;
                        clearTimeout(schedule._t);
                        schedule._t = setTimeout(()=>{ schedule._remaining=null; doShow(); }, rem);
                        if(DEBUG_PROMO) console.log('[PROMO] resume, nuevo rem', rem);
                    } else {
                        // Si no había remaining (ej: larga suspensión), recalcula
                        nextPlannedTs = Date.now() + interval;
                        schedule();
                    }
                }
            });
        });
        // Exit intent (desktop). Detectar mouse hacia top.
    // Exit intent (desktop): salida por borde superior
    document.addEventListener('mouseleave', e=>{ if(e.clientY<=0) showPopup('exit', null, {ignoreCooldown:true}); });
    // Cambio de pestaña / minimizar: si el usuario abandona rápido sin ver promos
    let pageLeaveArmed = true;
    document.addEventListener('visibilitychange', ()=>{
        if(document.hidden){
            if(pageLeaveArmed && !shownFlags.exit && !promoSession.shown.exit){
                setTimeout(()=>{ if(document.hidden) showPopup('exit', null, {ignoreCooldown:true}); }, 250);
            }
        }
    });
    // pagehide (Safari / navegadores móviles)
    window.addEventListener('pagehide', ()=>{
        if(!shownFlags.exit && !promoSession.shown.exit){ showPopup('exit', null, {ignoreCooldown:true}); }
    });
    // Eliminado popup intermedio e inactividad para no abrumar
        // Interceptar logout
    document.addEventListener('click', e=>{
            const link = e.target.closest('a'); if(!link) return;
            const href = link.getAttribute('href')||'';
            if(/logout|cerrar-sesion|salir/i.test(href)){
                if(!shownFlags.logout){ e.preventDefault(); showPopup('logout'); setTimeout(()=>{ window.location.href = href; }, 2600); }
            }
        });
    })();
    </script>
    
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function rouletteGame() {
            return {
                isOpen: false,
                showLoginModal: false,
                isSpinning: false,
                hasPlayed: false,
                prizeResult: null,
                whatsappLink: '',
                message: 'Prueba tu suerte para ganar un premio especial.',
                isAdmin: {{ request.user.is_superuser|yesno:'true,false' }},
                currentRotation: 0, // rotación acumulada de la rueda
                taglines: [
                    'Gira y gana premios',
                    '¿Ya probaste tu suerte hoy?',
                    'Descuentos sorpresa te esperan',
                    'Premios exclusivos sólo hoy',
                    'Haz clic y conquista la suerte'
                ],
                taglineIndex: 0,
                
                prizes: {{ roulette_prizes_json|safe }},
                config: {{ roulette_config_json|safe }},
                whatsappBaseLink: "{{ configuracion_sitio.whatsapp_link|default:'' }}",
                
                init() {
                    // Límite 3 intentos por día (por usuario / dispositivo)
                    const today = new Date().toISOString().split('T')[0];
                    const USER_ID = '{% if request.user.is_authenticated %}u{{ request.user.id }}{% else %}anon{% endif %}';
                    const KEY = 'fiRouletteAttempts::'+USER_ID+'::'+today;
                    const raw = localStorage.getItem(KEY);
                    let attempts = parseInt(raw||'0',10); if(isNaN(attempts)) attempts=0;
                    this._attemptKey = KEY;
                    this.attempts = attempts;
                    this.maxAttempts = 3;
                    if(this.attempts >= this.maxAttempts && !this.isAdmin){ this.hasPlayed = true; }
                    // Iniciar rotación de frases mientras no esté abierta la modal
                    this.cycleTaglines();
                    // Si hay countdown, arrancar timer local decreciente
                    if(this.config && typeof this.config.remaining_seconds === 'number' && this.config.remaining_seconds > 0){
                        const tick=()=>{
                            if(this.config.remaining_seconds>0){
                                this.config.remaining_seconds -= 1;
                            } else {
                                this.isOpen = false; // cerrar cuando termine
                            }
                            setTimeout(tick, 1000);
                        };
                        setTimeout(tick, 1000);
                    }
                },
                formatCountdown(total){
                    if(!total || total<=0) return 'Finaliza pronto';
                    const d = Math.floor(total/86400); total%=86400;
                    const h = Math.floor(total/3600); total%=3600;
                    const m = Math.floor(total/60); const s = total%60;
                    const pad=n=>String(n).padStart(2,'0');
                    let out='Termina en ';
                    if(d>0) out += d + 'd ';
                    out += pad(h)+':'+pad(m)+':'+pad(s);
                    return out;
                },
                formatCountdownShort(total){
                    if(!total || total<=0) return '00:00:00';
                    let r = total;
                    const d = Math.floor(r/86400); r%=86400;
                    const h = Math.floor(r/3600); r%=3600;
                    const m = Math.floor(r/60); const s = r%60;
                    const pad=n=>String(n).padStart(2,'0');
                    const hTot = d*24 + h;
                    return pad(hTot)+':'+pad(m)+':'+pad(s);
                },
                parseISO(iso){ try{ return iso? Date.parse(iso) : null; }catch(e){ return null; } },
                progressPercent(){
                    const fin = this.parseISO(this.config.fecha_fin);
                    const ini = this.parseISO(this.config.fecha_inicio);
                    if(!fin){ return 0; }
                    const total = (ini && fin) ? Math.max(1, fin - ini) : null;
                    const remaining = Math.max(0, (this.config.remaining_seconds||0)) * 1000;
                    if(total){ return Math.max(0, Math.min(100, Math.round((remaining/total)*100))); }
                    const max = 24*3600*1000; // fallback
                    return Math.max(0, Math.min(100, Math.round((remaining/max)*100)));
                },
                registerAttempt(){
                    if(this.isAdmin) return; // admins ilimitado
                    this.attempts = Math.min(this.attempts+1, this.maxAttempts);
                    try{ localStorage.setItem(this._attemptKey, String(this.attempts)); }catch(e){}
                    if(this.attempts >= this.maxAttempts){ this.hasPlayed = true; }
                },
                cycleTaglines(){
                    if(this.taglines.length===0) return;
                    const advance=()=>{
                        if(this.isOpen) { setTimeout(advance, 4500); return; }
                        this.taglineIndex = (this.taglineIndex+1)%this.taglines.length;
                        const text = this.taglines[this.taglineIndex];
                        // Actualizar callouts externos si existen
                        document.querySelectorAll('.roulette-fab-callout span').forEach(s=>{ s.textContent = text; });
                        setTimeout(advance, 4500);
                    };
                    setTimeout(advance, 4500);
                },
                
                get wheelStyle() {
                    const colors = ['#fecdd3', '#fbcfe8', '#f9a8d4', '#f472b6', '#ec4899', '#db2777', '#be185d', '#9d174d'];
                    if (this.prizes.length === 0) return '#fecdd3';
                    let gradient = 'conic-gradient(';
                    const step = 100 / this.prizes.length;
                    this.prizes.forEach((prize, i) => {
                        const color = colors[i % colors.length];
                        gradient += `${color} ${i * step}% ${(i + 1) * step}%`;
                        if (i < this.prizes.length - 1) gradient += ', ';
                    });
                    gradient += ')';
                    return gradient;
                },
                
                // === INICIO DE LA MEJORA: JS para Estilo del Texto de la Ruleta ===
                prizeStyle(index) {
                    const total = this.prizes.length || 1;
                    const anglePer = 360 / total;
                    const rot = (index * anglePer) + (anglePer/2) - 90; // ángulo radial
                    const prize = this.prizes[index] || {};
                    const txt = (prize.nombre || prize.name || '').trim();
                    // Escala según longitud (más líneas => menos escala)
                    let scale = 1;
                    if (txt.length > 16) scale = 0.92;
                    if (txt.length > 28) scale = 0.85;
                    if (txt.length > 40) scale = 0.78;
                    if (txt.length > 52) scale = 0.7;
                    /*
                     * Rayo: el borde izquierdo del bloque queda en el centro (transform-origin 0% 50%).
                     * No aplicamos traslación inicial (translateX) para que nazca en el centro.
                     * Sólo empujamos un poco para despegar del centro y evitar tapa del hub.
                     */
                    const offset = 28;
                    return `transform: rotate(${rot}deg) translateX(${offset}%) scale(${scale});`;
                },
                formatPrize(prize, index){
                    const text = (prize.nombre || prize.name || '').trim();
                    if(!text) return '';
                    const words = text.split(/\s+/);
                    const length = text.length;
                    // Decidir número de líneas: 1 corta, 2 media, 3 muy larga
                    let linesTarget = 1;
                    if(length > 16) linesTarget = 2;
                    if(length > 28) linesTarget = 3;
                    if(words.length <= linesTarget) {
                        return words.map(w=>w.toUpperCase()).join('<br>');
                    }
                    const avg = Math.ceil(length / linesTarget);
                    const lines = []; let current='';
                    words.forEach(w=>{
                        if((current + ' ' + w).trim().length <= avg || lines.length >= linesTarget-1){
                            current = (current? current + ' ' : '') + w;
                        } else {
                            lines.push(current); current = w;
                        }
                    });
                    if(current) lines.push(current);
                    while(lines.length > linesTarget){
                        const last = lines.pop();
                        lines[lines.length-1] += ' ' + last;
                    }
                    return lines.map(l=>l.toUpperCase()).join('<br>');
                },

                renderCurvedText(){
                    const svg = document.getElementById('roulette-svg');
                    if(!svg) return; 
                    svg.innerHTML='';
                    const total = this.prizes.length || 1;
                    if(!total) return;
                    const center = 500;
                    const baseRadius = 430; // radio donde se colocará el texto
                    const anglePerSlice = 360/total;
                    const reduceFactor = 0.78; // arc length dentro de la tajada
                    const arcSpan = anglePerSlice * reduceFactor;
                    const toRad = deg => deg * Math.PI/180;
                    const polar = (r,deg)=>{ const rad = toRad(deg-90); return {x: center + r*Math.cos(rad), y: center + r*Math.sin(rad)} };
                    this.prizes.forEach((prize,i)=>{
                        const centerAngle = (i*anglePerSlice)+(anglePerSlice/2);
                        const startAngle = centerAngle - arcSpan/2;
                        const endAngle = centerAngle + arcSpan/2;
                        const mid = centerAngle % 360;
                        let start = startAngle; let end = endAngle; let inverted=false;
                        if(mid > 90 && mid < 270){ inverted=true; start = endAngle; end = startAngle; }
                        const p1 = polar(baseRadius,start); const p2 = polar(baseRadius,end);
                        const largeArc = (Math.abs(end-start) > 180)?1:0; // siempre 0 normalmente
                        const pathId = 'arc-path-'+i;
                        const d = `M ${p1.x.toFixed(2)} ${p1.y.toFixed(2)} A ${baseRadius} ${baseRadius} 0 ${largeArc} ${inverted?0:1} ${p2.x.toFixed(2)} ${p2.y.toFixed(2)}`;
                        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
                        path.setAttribute('id',pathId); path.setAttribute('d',d); path.setAttribute('fill','none');
                        svg.appendChild(path);
                        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
                        let cls='xl';
                        const label = (prize.nombre || prize.name || '').trim();
                        const len = label.length;
                        if(len>18) cls='large'; if(len>24) cls='medium'; if(len>32) cls='small';
                        text.setAttribute('class','arc-label '+cls);
                        const textPath = document.createElementNS('http://www.w3.org/2000/svg','textPath');
                        textPath.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','#'+pathId);
                        textPath.setAttribute('startOffset','50%');
                        textPath.setAttribute('text-anchor','middle');
                        textPath.textContent = label.toUpperCase();
                        text.appendChild(textPath);
                        svg.appendChild(text);
                    });
                },
                // === FIN DE LA MEJORA ===

                getTotalAttemptsGlobal(){
                    try { return parseInt(localStorage.getItem('fiRouletteAttemptsTotal::' + ('{% if request.user.is_authenticated %}u{{ request.user.id }}{% else %}anon{% endif %}'))||'0',10)||0; } catch(e){ return 0; }
                },
                incTotalAttempts(){
                    const key = 'fiRouletteAttemptsTotal::' + ('{% if request.user.is_authenticated %}u{{ request.user.id }}{% else %}anon{% endif %}');
                    let val = this.getTotalAttemptsGlobal();
                    val = Math.min(val+1, 999);
                    try { localStorage.setItem(key, String(val)); }catch(e){}
                    return val;
                },
                attemptsRemaining(){ return Math.max(this.maxAttempts - this.attempts, 0); },
                openRoulette() {
                    if ({{ request.user.is_authenticated|yesno:'true,false' }}) {
                        this.isOpen = true;
                    } else {
                        this.showLoginModal = true;
                    }
                },

                async spin() {
                    if (this.isSpinning || (this.hasPlayed && !this.isAdmin)) return;
                    if (this.config && typeof this.config.remaining_seconds === 'number' && this.config.remaining_seconds <= 0) {
                        this.message = 'La promoción ha finalizado.';
                        return;
                    }
                    // Registrar intento inmediatamente
                    this.registerAttempt();
                    this.incTotalAttempts();
                    if(this.attempts >= this.maxAttempts && !this.isAdmin){ this.hasPlayed = true; }
                    if (this.prizes.length === 0) {
                        this.message = 'No hay premios disponibles.';
                        return;
                    }

                    this.isSpinning = true;
                    this.prizeResult = null;
                    const rem = this.attemptsRemaining();
                    this.message = rem>0 ? `¡Mucha suerte! (Te quedarán ${rem} intento${rem===1?'':'s'})` : 'Último intento, ¡aprovéchalo!';

                    try { await Tone.start(); } catch (e) { console.warn("No se pudo iniciar AudioContext:", e); }

                    const tickSynth = this.config.sonido_giro_url ? null : new Tone.MembraneSynth().toDestination();

                    if (this.config.sonido_giro_url) {
                        const player = new Tone.Player(this.config.sonido_giro_url).toDestination();
                        await Tone.loaded();
                        player.start();
                    }
                    
                    try {
                        const response = await fetch("{% url 'spin_roulette' %}", {
                            method: "POST",
                            headers: { "X-CSRFToken": getCookie('csrftoken'), "Content-Type": "application/json" },
                            body: JSON.stringify({})
                        });
                        const data = await response.json();
                        
                        if (typeof data.winning_index !== 'number') {
                            throw new Error('Respuesta inválida del servidor.');
                        }

                        const winningIndex = data.winning_index;
                        const segmentAngle = 360 / this.prizes.length;
                        const targetAngle = 360; // El puntero está arriba, que es -90 o 270 grados
                        const centerOfSegment = (winningIndex * segmentAngle) + (segmentAngle / 2);
                        const rotationNeeded = (360 + targetAngle - centerOfSegment) % 360;
                        const totalRotation = (360 * 5) + rotationNeeded; // 5 vueltas completas + la final

                        const wheel = document.getElementById('roulette-wheel');
                        this.animateSpin(wheel, totalRotation, 5000, tickSynth, () => {
                            this.onSpinComplete(data);
                        });

                    } catch (error) {
                        console.error("Error al girar la ruleta:", error);
                        this.message = 'Ocurrió un error. Inténtalo nuevamente.';
                        this.isSpinning = false;
                    }
                },
                
                animateSpin(element, targetRotation, duration, tickSynth, onComplete) {
                    let startTime = null;
                    const startRotation = 0;
                    element.style.transform = 'rotate(0deg)';
                    let lastTickTime = 0;
                    const minTickInterval = 80; 
                    const maxTickInterval = 700;
                    const animation = (currentTime) => {
                        if (startTime === null) startTime = currentTime;
                        const timeElapsed = currentTime - startTime;
                        const progress = Math.min(timeElapsed / duration, 1);
                        const easedProgress = 1 - Math.pow(1 - progress, 4); // easeOutQuart
                        const currentRotation = startRotation + (targetRotation * easedProgress);
                        this.currentRotation = currentRotation; // actualizar para que Alpine recalcule estilos de texto
                        element.style.transform = `rotate(${currentRotation}deg)`;
                        if (tickSynth) {
                            const currentTickInterval = minTickInterval + (maxTickInterval - minTickInterval) * easedProgress;
                            if (currentTime > lastTickTime + currentTickInterval) {
                                tickSynth.triggerAttackRelease("C1", "8n", Tone.now());
                                lastTickTime = currentTime;
                            }
                        }
                        if (timeElapsed < duration) {
                            requestAnimationFrame(animation);
                        } else {
                            if (onComplete) onComplete();
                        }
                    };
                    requestAnimationFrame(animation);
                },

                onSpinComplete(data) {
                    this.isSpinning = false;
                    this.prizeResult = data.prize;
                    if (data.prize && this.whatsappBaseLink) {
                        const prizeName = data.prize.name || 'un premio';
                        const couponCode = data.prize.coupon_code || 'N/A'; 
                        const message = `¡Hola! Acabo de ganar '${prizeName}' en la ruleta. Mi código de cupón para validar es: ${couponCode}`;
                        const encodedMessage = encodeURIComponent(message);
                        this.whatsappLink = `${this.whatsappBaseLink}?text=${encodedMessage}`;
                    } else {
                        this.whatsappLink = '#'; 
                    }
                    if (this.config.sonido_premio_url) {
                        const player = new Tone.Player(this.config.sonido_premio_url).toDestination();
                        Tone.loaded().then(() => { player.start(); });
                    } else {
                        const winSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                        winSynth.triggerAttackRelease(["C5", "G5", "C6"], "8n", Tone.now());
                    }
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                    const bigWin = document.getElementById('big-win-text');
                    bigWin.classList.add('show');
                    setTimeout(() => bigWin.classList.remove('show'), 2500);
                    const rem = typeof data.remaining === 'number' ? data.remaining : 0;
                    if(rem>0){
                        this.message = `¡Felicidades! Te quedan ${rem} intento${rem===1?'':'s'}.`;
                        this.hasPlayed = false;
                    } else {
                        this.message = '¡Felicidades! Se acabaron tus intentos.';
                        this.hasPlayed = true;
                    }
                }
            }
        }
    </script>
    <script>
    // Activar animación de atracción cíclica y asegurar callout desktop
    document.addEventListener('DOMContentLoaded',()=>{
        const desktopFab = document.getElementById('roulette-fab');
        if(desktopFab && !desktopFab.querySelector('.roulette-fab-callout')){
            const call = document.createElement('div');
            call.className='roulette-fab-callout';
            call.innerHTML='<i class="fas fa-bolt"></i><span>Gira y gana premios</span>';
            desktopFab.appendChild(call);
        }
        function pulse(){
            if(desktopFab){ desktopFab.classList.add('attract'); setTimeout(()=>desktopFab.classList.remove('attract'),2100); }
            const mobileFab = document.getElementById('roulette-fab-mobile');
            if(mobileFab){ mobileFab.classList.add('attract'); setTimeout(()=>mobileFab.classList.remove('attract'),2100);}            
            setTimeout(pulse, 7000);
        }
        setTimeout(pulse, 2500);
    });
    </script>
    <!-- Script de padding-top dinámico removido: se elimina espacio en blanco superior en catálogo -->

</body>
</html>
