{% extends 'base.html' %}
{% load static %}

{% block body_class %}catalog-page{% endblock %}

{% block title %}Catálogo - {{ block.super }}{% endblock %}

{% block content %}

<!-- 
 =======================================================================
 HERO BANNER
 =======================================================================
-->
{# Usamos banners_activos provistos por el context_processor. Si hay al menos
   uno, mostramos el primero (puedes cambiar a carousel más adelante). Si no,
   dejamos el hero por defecto intacto. #}
{% if banners_activos and banners_activos|length > 0 %}
    {% with b=banners_activos.0 %}
    <section 
        class="relative w-full h-64 sm:h-80 flex items-center justify-center text-white bg-gray-400"
        style="background-image: url('{{ b.imagen_url }}'); background-size: cover; background-position: center;"
        role="img"
        aria-label="{{ b.titulo }}">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative text-center p-4">
            <h1 class="text-4xl sm:text-6xl md:text-7xl font-brand drop-shadow-lg">{{ b.titulo }}</h1>
            {% if b.subtitulo %}
                <p class="mt-2 text-lg sm:text-xl drop-shadow-md">{{ b.subtitulo }}</p>
            {% endif %}
            <a 
                href="{{ b.destino_url|default:'#product-list-section' }}" 
                class="mt-6 inline-block text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-opacity-90 transform hover:scale-105 transition-all"
                style="background-color: var(--brand-accent);">
                {{ b.texto_boton }}
            </a>
        </div>
    </section>
    {% endwith %}
{% else %}
    <section class="hero-banner relative w-full h-64 sm:h-80 flex items-center justify-center text-white">
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative text-center p-4">
            <h1 class="text-4xl sm:text-6xl md:text-7xl font-brand drop-shadow-lg">Nueva Colección</h1>
            <p class="mt-2 text-lg sm:text-xl drop-shadow-md">Descubre la sensualidad en cada detalle</p>
            <a 
                href="?categoria=nueva_coleccion#product-list-section" 
                class="js-category-link mt-6 inline-block text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-opacity-90 transform hover:scale-105 transition-all"
                data-filter="categoria" data-value="nueva_coleccion" onclick="handleFilterClick(event)"
                style="background-color: var(--brand-accent);">
                Ver ahora
            </a>
        </div>
    </section>
{% endif %}


<!-- 
 =======================================================================
 CONTENIDO PRINCIPAL (Sidebar y Lista de Productos)
 =======================================================================
-->
<div class="container mx-auto px-4 flex flex-col lg:flex-row gap-8 mt-8">

    <!-- 
      =================================
      SIDEBAR DE FILTROS Y CATEGORÍAS
      =================================
    -->
    <aside id="filters-sidebar" class="w-full lg:w-72 bg-white shadow-lg rounded-2xl p-6 border lg:sticky top-4 h-max" style="border-color: rgba(var(--brand-primary-rgb), 0.3);">
        <h3 class="font-extrabold text-2xl mb-6 tracking-wide flex items-center gap-2" style="color: var(--brand-accent);">
            <i class="fas fa-list"></i> Categorías
        </h3>

        <ul class="space-y-3">
            <li>
                <a 
                    href="{% url 'catalogo_publico' %}#product-list-section"
                    class="js-category-link block px-3 py-2 rounded-lg text-lg font-bold shadow-sm transition-all hover:underline"
                    style="color: var(--brand-accent); {% if not filtros_activos.categoria %}background-color: rgba(var(--brand-primary-rgb), 0.2); border: 1px solid var(--brand-primary);{% endif %}"
                    data-filter="categoria" data-value="" onclick="handleFilterClick(event)">
                    Todos
                </a>
            </li>
            {% for cat in categorias_menu %}
                <li>
                    <a 
                        href="?categoria={{ cat.slug }}#product-list-section"
                        class="js-category-link block px-3 py-2 rounded-lg text-lg font-bold shadow-sm transition-all hover:underline"
                        style="color: var(--brand-accent); {% if filtros_activos.categoria == cat.slug %}background-color: rgba(var(--brand-primary-rgb), 0.2); border: 1px solid var(--brand-primary);{% endif %}"
                        data-filter="categoria" data-value="{{ cat.slug }}" onclick="handleFilterClick(event)">
                        {{ cat.nombre }}
                    </a>
                    
                    {% if cat.children.all %}
                        <ul class="ml-4 mt-2 space-y-1 pl-3" style="border-left: 2px solid var(--brand-primary);">
                            {% for subcat in cat.children.all %}
                                <li>
                                    <a 
                                        href="?categoria={{ subcat.slug }}#product-list-section"
                                        class="js-category-link block px-2 py-1 rounded text-base transition-all"
                                        style="color: var(--brand-text); {% if filtros_activos.categoria == subcat.slug %}background-color: rgba(var(--brand-primary-rgb), 0.2); color: var(--brand-accent); font-weight: 600;{% endif %}"
                                        data-filter="categoria" data-value="{{ subcat.slug }}" onclick="handleFilterClick(event)">
                                        {{ subcat.nombre }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <div class="mt-10 space-y-6">
            <div>
                <h4 class="font-bold mb-2" style="color: var(--brand-accent);">Filtrar por precio</h4>
                <form id="price-form" class="flex flex-col gap-2">
                    <input type="number" name="precio_min" placeholder="Mín" value="{{ filtros_activos.precio_min|default:'' }}" class="w-full rounded border px-2 py-1">
                    <input type="number" name="precio_max" placeholder="Máx" value="{{ filtros_activos.precio_max|default:'' }}" class="w-full rounded border px-2 py-1">
                    <button id="price-filter-btn" type="submit" class="w-full mt-2 rounded px-4 py-1 text-white transition-all flex items-center justify-center" style="background-color: var(--brand-accent);">
                        <span class="btn-text">Aplicar</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden btn-loader"></i>
                    </button>
                </form>
            </div>
        </div>
    </aside>

    <!-- 
      =================================
      CONTENIDO PRINCIPAL (PRODUCTOS)
      =================================
    -->
    <main class="flex-1">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <h2 id="products-heading" class="text-4xl font-brand" style="color: var(--brand-text);" tabindex="-1">Nuestros Productos</h2>
            <div class="flex items-center gap-4">
                <label for="sort-by" class="font-semibold whitespace-nowrap">Ordenar por:</label>
                <select id="sort-by" name="orden" class="rounded-full border-gray-300 shadow-sm" style="--tw-ring-color: var(--brand-accent);">
                    <option value="default" {% if not filtros_activos.orden or filtros_activos.orden == 'default' %}selected{% endif %}>Relevancia</option>
                    <option value="price-asc" {% if filtros_activos.orden == 'price-asc' %}selected{% endif %}>Precio: Menor a Mayor</option>
                    <option value="price-desc" {% if filtros_activos.orden == 'price-desc' %}selected{% endif %}>Precio: Mayor a Menor</option>
                </select>
            </div>
        </div>

        <div id="product-list-section" aria-live="polite">
            {% include 'partials/_product_list_ajax.html' %}
        </div>
    </main>

</div>

{% endblock %}

{% block extra_js %}
<script>
    let productListContainer;
    let skeleton;

    async function updateProducts(url, formButton = null) {
        if (!productListContainer || !skeleton) {
            productListContainer = document.getElementById('product-list-section');
            skeleton = document.getElementById('list-skeleton');
        }
        
        const skeletonHTML = skeleton.outerHTML;
        productListContainer.innerHTML = skeletonHTML;
        productListContainer.querySelector('#list-skeleton').classList.remove('hidden');

        // === INICIO DE LA MEJORA: Feedback visual en el botón ===
        if (formButton) {
            formButton.disabled = true;
            formButton.querySelector('.btn-text').classList.add('hidden');
            formButton.querySelector('.btn-loader').classList.remove('hidden');
        }
        // === FIN DE LA MEJORA ===

        try {
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const html = await response.text();
            productListContainer.innerHTML = html;

            const heading = document.getElementById('products-heading');
            if (heading) heading.focus();

        } catch (error) {
            console.error('Error al actualizar los productos:', error);
            productListContainer.innerHTML = '<p class="text-center text-red-500">Hubo un error al cargar los productos.</p>';
        } finally {
            // === INICIO DE LA MEJORA: Restaurar el botón ===
            if (formButton) {
                formButton.disabled = false;
                formButton.querySelector('.btn-text').classList.remove('hidden');
                formButton.querySelector('.btn-loader').classList.add('hidden');
            }
            // === FIN DE LA MEJORA ===
        }
    }

    function handleStateChange(params, formButton = null) {
        params.set('page', '1');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.pushState({}, '', newUrl);
        updateProducts(newUrl, formButton);
    }

    function handleFilterClick(event) {
        event.preventDefault();
        
        const link = event.currentTarget;
        const filterType = link.dataset.filter;
        const filterValue = link.dataset.value;

        const params = new URLSearchParams(window.location.search);
        
        if (filterValue) {
            params.set(filterType, filterValue);
        } else {
            params.delete(filterType);
        }
        
        handleStateChange(params);
    }

    document.addEventListener('DOMContentLoaded', () => {
        productListContainer = document.getElementById('product-list-section');
        skeleton = document.getElementById('list-skeleton');
        
        const sortBySelect = document.getElementById('sort-by');
        const priceForm = document.getElementById('price-form');

        sortBySelect.addEventListener('change', () => {
            const params = new URLSearchParams(window.location.search);
            params.set('orden', sortBySelect.value);
            handleStateChange(params);
        });

        priceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(priceForm);
            const params = new URLSearchParams(window.location.search);
            params.set('precio_min', formData.get('precio_min') || '');
            params.set('precio_max', formData.get('precio_max') || '');
            handleStateChange(params, e.currentTarget.querySelector('button'));
        });

        productListContainer.addEventListener('click', (e) => {
            const pageLink = e.target.closest('nav a');
            if (!pageLink) return;

            e.preventDefault();
            const url = pageLink.getAttribute('href');
            if (url) {
                history.pushState({}, '', url);
                updateProducts(url);
            }
        });

        window.addEventListener('popstate', () => {
            updateProducts(window.location.href);
        });
    });
</script>
{% endblock extra_js %}
