{% extends 'base.html' %}
{% load static %}

{% block body_class %}catalog-page{% endblock %}

{% block title %}Catálogo - {{ block.super }}{% endblock %}

{% block content %}

<script>
    // Flag del servidor que indica que la vista fue cargada desde un banner
    // Flag inicial enviado por el servidor: incluye productos=, solo_ofertas=1 o categoria=nueva_coleccion
    window.BANNER_FILTERED = {{ banner_mode_active|yesno:'true,false' }};
// -------------------------------------------------------------
// MODO FILTRO POR BANNER (productos=): desactivar AJAX y paginación dinámica
// -------------------------------------------------------------
(function(){
    if(window.BANNER_FILTERED) return; // ya establecido desde el servidor
    const params = new URLSearchParams(window.location.search);
    if(params.get('productos') || params.get('solo_ofertas') === '1' || params.get('categoria') === 'nueva_coleccion'){
        window.BANNER_FILTERED = true;
        document.addEventListener('DOMContentLoaded', ()=>{ document.body.classList.add('banner-filtered-mode'); });
    }
})();
</script>
<script>
// ================= REGLA ÚNICA DE RESALTADO =================
// Comportamiento:
//  - Sin categoria (?categoria ausente): resalta "Todos" en chips y enlace "Todos" en sidebar/panel.
//  - Categoria raíz seleccionada: resalta sólo esa raíz (chips + sidebar/panel).
//  - Subcategoría seleccionada: chips muestran resaltada la raíz; en sidebar/panel se resalta SOLO la subcategoría.
(function(){
    const ACTIVE_BG = 'rgba(var(--brand-primary-rgb,255,105,180),0.18)';
    const ACTIVE_BORDER = '1px solid var(--brand-accent)';
    const ACTIVE_COLOR = 'var(--brand-accent)';
    // Contador de reintentos para casos donde el mapa aún no está listo
    const pendingRetries = {};

    function resetLinks(sel){
        document.querySelectorAll(sel).forEach(a=>{
            a.classList.remove('fi-active-cat','chip-active');
            // Siempre limpiar estilos de highlight (dinámicos o servidor) para que no queden residuos
            a.style.backgroundColor='';
            a.style.border='';
            a.style.color='';
            a.style.fontWeight='';
            delete a.dataset._dyn;
            // Quitar utilidades tailwind usadas en render inicial para marcar activo
            a.classList.remove('bg-[rgba(var(--brand-primary-rgb),0.15)]','border-[var(--brand-accent)]','text-[var(--brand-accent)]');
        });
    }

    function styleActive(a, isChip){
        a.classList.add(isChip? 'chip-active':'fi-active-cat');
        a.dataset._dyn='1';
        a.style.backgroundColor = ACTIVE_BG;
        a.style.border = ACTIVE_BORDER;
        a.style.color = ACTIVE_COLOR;
        a.style.fontWeight = '600';
    }

    function getRoot(slug){
        if(!slug) return '';
        const map = window.__SUBCAT_PARENT_MAP || {};
        if(map[slug]) return map[slug];
        // Fallback DOM: localizar root a partir de la estructura del sidebar
        try {
            const subA = document.querySelector(`#filters-sidebar a.js-category-link[data-value="${slug}"]`) || document.querySelector(`#mobile-filters-content a.js-category-link[data-value="${slug}"]`);
            if(subA){
                const outerLi = subA.closest('li')?.closest('ul')?.closest('li');
                const rootA = outerLi ? outerLi.querySelector(':scope > a.js-category-link') : null;
                const rootSlug = rootA?.dataset.value || slug;
                if(rootSlug && rootSlug !== slug){
                    window.__SUBCAT_PARENT_MAP = window.__SUBCAT_PARENT_MAP || {};
                    window.__SUBCAT_PARENT_MAP[slug] = rootSlug;
                    return rootSlug;
                }
            }
        } catch(e){ console.debug('fallback root error', e); }
        return slug;
    }

    function applyCategoryHighlight(slug){
        const isSub = slug && (window.__SUBCAT_PARENT_MAP||{})[slug];
        const root = getRoot(slug||'');
        // Si esperamos un root pero el mapa todavía está vacío, reintentar ligeramente después
        if(slug && !root && Object.keys(window.__SUBCAT_PARENT_MAP||{}).length===0){
            if((pendingRetries[slug]||0) < 5){
                pendingRetries[slug] = (pendingRetries[slug]||0)+1;
                return setTimeout(()=>applyCategoryHighlight(slug), 50);
            }
        }
        if(slug){ console.debug('[highlight] slug:', slug, 'root:', root, 'isSub:', !!isSub); }

        // Chips (sólo raíz o Todos)
        resetLinks('#mobile-category-chips a.js-category-link');
        const chipNodes = document.querySelectorAll('#mobile-category-chips a.js-category-link');
        let chipHighlighted = false;
        chipNodes.forEach(a=>{
            const val = a.dataset.value || '';
            if(val === root){ styleActive(a, true); chipHighlighted = true; }
        });
        // Refuerzo sin CSS.escape (compatibilidad): segunda pasada si es subcat y aún no se resaltó
        if(isSub && root && !chipHighlighted){
            chipNodes.forEach(a=>{ if(!chipHighlighted && (a.dataset.value||'')===root){ styleActive(a,true); chipHighlighted=true; } });
        }

        // Sidebar + Panel (root y subcategorías)
        resetLinks('#filters-sidebar a.js-category-link, #mobile-filters-content a.js-category-link');
        const all = document.querySelectorAll('#filters-sidebar a.js-category-link, #mobile-filters-content a.js-category-link');
        all.forEach(a=>{
            const val = a.dataset.value || '';
            // Caso Todos
            if(!slug && val===''){ styleActive(a,false); return; }
            // Caso raíz seleccionada
            if(!isSub && slug && val===slug){ styleActive(a,false); return; }
            // Caso subcategoría: sólo la subcat
            if(isSub && val===slug){ styleActive(a,false); return; }
        });
    }

    // Exponer (sustituye versiones previas)
    window.setActiveCategory = applyCategoryHighlight;

    function syncFromURL(){
        const slug = new URLSearchParams(location.search).get('categoria') || '';
        applyCategoryHighlight(slug);
    }

    document.addEventListener('DOMContentLoaded', syncFromURL);
    window.addEventListener('popstate', syncFromURL);

    // Delegar clicks en chips
    const chipsBar = document.getElementById('mobile-category-chips');
    if(chipsBar){
        chipsBar.addEventListener('click', e=>{
            const a = e.target.closest('a.js-category-link'); if(!a) return;
            applyCategoryHighlight(a.dataset.value||'');
        });
    }

    // Hook tras AJAX (si updateProducts existe)
    if(typeof updateProducts==='function' && !window.__highlightWrapped){
        const original = updateProducts; window.__highlightWrapped=true;
        window.updateProducts = async function(){
            const r = await original.apply(this, arguments);
            syncFromURL();
            return r;
        };
    }

})();
</script>
<style>
/* Refuerzo estilo chip activo (en caso de que Tailwind purge elimine variantes) */
#mobile-category-chips a.chip-active{
    background-color: rgba(var(--brand-primary-rgb,255,105,180),0.18) !important;
    border:1px solid var(--brand-accent) !important;
    color: var(--brand-accent) !important;
}
</style>

<script>
// Forzar navegación completa en banner (por si algún handler global intercepta)
document.addEventListener('click', function(e){
    const a = e.target.closest && e.target.closest('a.banner-cta');
    if(!a) return;
    const href = a.getAttribute('href')||'';
    if(href.includes('solo_ofertas=1')){
        // desactivar cualquier bandera ajax y hacer location directa
        window.BANNER_FILTERED = true;
        window.location.href = href.replace('#product-list-section','')+ '#product-list-section';
        e.preventDefault();
    }
});
</script>

<!-- 
 =======================================================================
 HERO BANNER (añadido: animaciones móviles)
 =======================================================================
-->
{# Hero dinámico: se muestra el primer banner activo; si no hay, hero por defecto. #}
{% if banners_activos and banners_activos|length > 0 %}
    {% with b=banners_activos.0 %}
    <section 
        class="hero-animate hero-banner relative w-full flex items-center justify-center text-white bg-gray-400"
        style="background-image: url('{{ b.imagen_url }}'); background-size: cover; background-position: center;"
        role="img"
        aria-label="{{ b.titulo }}">
        <div class="hero-overlay absolute inset-0"></div>
        <div class="hero-content relative text-center p-4">
            <h1 class="hero-title text-3xl sm:text-5xl md:text-6xl font-brand drop-shadow-lg leading-tight">{{ b.titulo }}</h1>
            {% if b.subtitulo %}
                <p class="hero-sub mt-2 text-base sm:text-xl drop-shadow-md">{{ b.subtitulo }}</p>
            {% endif %}
            <a 
                href="{{ b.destino_url|default:'#product-list-section' }}" 
                class="banner-cta hero-cta mt-6 inline-block text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-opacity-90 transform hover:scale-105 transition-all"
                style="background-color: var(--brand-accent);">
                {{ b.texto_boton }}
            </a>
            {% if b.fecha_fin %}
                <div class="mt-4 hero-countdown-wrapper">
                        <div class="countdown-badge inline-flex items-center gap-3" aria-live="polite">
                            <span class="countdown-label text-xs uppercase tracking-wide" style="background-color: var(--brand-accent); color: #fff; padding:4px 8px; border-radius:6px;">Tiempo restante</span>
                            <div class="countdown text-xl font-extrabold px-3 py-1 rounded-lg" style="background-color: #fff; color: var(--brand-accent);" data-fecha-fin="{{ b.fecha_fin|date:'c' }}"></div>
                        </div>
                        <p class="countdown-message mt-2 text-sm font-semibold" style="display:none; color: #fff;">Apresúrate, la oferta termina pronto.</p>
                </div>
            {% endif %}
        </div>
    </section>
    {% endwith %}
{% else %}
    <section class="hero-animate hero-banner relative w-full flex items-center justify-center text-white">
        <div class="hero-overlay absolute inset-0 bg-black/30"></div>
        <div class="hero-content relative text-center p-4">
            <h1 class="hero-title text-3xl sm:text-5xl md:text-6xl font-brand drop-shadow-lg leading-tight">Nueva Colección</h1>
            <p class="hero-sub mt-2 text-lg sm:text-xl drop-shadow-md">Descubre la sensualidad en cada detalle</p>
            <a 
                href="?categoria=nueva_coleccion#product-list-section" 
                class="js-category-link hero-cta mt-6 inline-block text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-opacity-90 transform hover:scale-105 transition-all"
                data-filter="categoria" data-value="nueva_coleccion" onclick="handleFilterClick(event)"
                style="background-color: var(--brand-accent);">
                Ver ahora
            </a>
        </div>
    </section>
{% endif %}
    <!-- Barra de chips categorías (solo móvil) -->
    <script>
    // Parallax móvil del hero (restaurado)
    (function(){
        const hero = document.querySelector('.catalog-page .hero-animate');
        if(!hero) return;
        // Solo móvil / tablets pequeñas
        const mq = window.matchMedia('(max-width: 640px)');
        if(!mq.matches) return;
        if(window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
        let ticking=false; let lastY=window.scrollY;
        const maxOffset = 40; // desplazamiento máximo en px
        function onScroll(){
            lastY = window.scrollY;
            if(!ticking){
                requestAnimationFrame(()=>{
                    const offset = Math.min(maxOffset, lastY * 0.25);
                    // Usamos background-position Y dinámico
                    hero.style.backgroundPosition = `center calc(50% + ${offset}px)`;
                    ticking=false;
                });
                ticking=true;
            }
        }
        hero.style.willChange = 'background-position';
        window.addEventListener('scroll', onScroll, {passive:true});
    })();
    </script>
    <script>
    // Construir mapa subcategoria->padre vía DOM (evita inyectar template tags en JS)
    window.__SUBCAT_PARENT_MAP = window.__SUBCAT_PARENT_MAP || {};
    document.addEventListener('DOMContentLoaded', function(){
        try {
            const sidebar = document.getElementById('filters-sidebar');
            if(!sidebar) return;
            const rootItems = sidebar.querySelectorAll('> ul > li');
            rootItems.forEach(rootLi => {
                const rootA = rootLi.querySelector(':scope > a.js-category-link');
                if(!rootA) return;
                const rootSlug = rootA.dataset.value || '';
                // Subcategorías dentro de este li
                const subLinks = rootLi.querySelectorAll('ul li a.js-category-link');
                subLinks.forEach(subA => {
                    const subSlug = subA.dataset.value;
                    if(subSlug) window.__SUBCAT_PARENT_MAP[subSlug] = rootSlug;
                });
            });
            // Reaplicar estado activo con posible información de padres
            const params = new URLSearchParams(window.location.search);
            if(window.setActiveCategory){ window.setActiveCategory(params.get('categoria')||''); }
        } catch(e){ console.debug('MAP SUBCAT build error', e); }

        // Forzar resaltado inmediato al pulsar "Todos" en chips móviles
        const chipsBar = document.getElementById('mobile-category-chips');
        if(chipsBar){
            chipsBar.addEventListener('click', function(ev){
                const link = ev.target.closest('a.js-category-link');
                if(!link) return;
                if((link.dataset.value||'')===''){
                    // Pequeño timeout para asegurar que otros handlers terminen
                    setTimeout(()=>{ if(window.setActiveCategory) window.setActiveCategory(''); }, 10);
                }
            });
        }
    });
    </script>
    <div class="lg:hidden mt-3 px-1" id="mobile-category-chips">
        <div class="flex gap-1.5 overflow-x-auto no-scrollbar pb-0" style="scroll-snap-type:x proximity;">
            <a href="{% url 'catalogo_publico' %}#product-list-section" class="js-category-link shrink-0 px-3 py-1.5 rounded-full text-[13px] font-semibold border transition-colors scroll-snap-align-start text-[var(--brand-text)] border-gray-300" data-filter="categoria" data-value="" onclick="handleFilterClick(event)">Todos</a>
            {% for cat in categorias_menu %}
                <a href="?categoria={{ cat.slug }}#product-list-section" class="shrink-0 px-3 py-1.5 rounded-full text-[13px] font-semibold border transition-colors scroll-snap-align-start js-category-link {% if filtros_activos.categoria == cat.slug %}bg-[rgba(var(--brand-primary-rgb),0.15)] border-[var(--brand-accent)] text-[var(--brand-accent)]{% else %}text-[var(--brand-text)] border-gray-300{% endif %}" data-filter="categoria" data-value="{{ cat.slug }}" onclick="handleFilterClick(event)">{{ cat.nombre }}</a>
            {% endfor %}
        </div>
    </div>

    <!-- Barra fija inferior (móvil) -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 z-40 flex justify-around bg-white/95 backdrop-blur border-t shadow-md py-1" id="mobile-action-bar">
        <button id="open-filters-btn" class="flex flex-col items-center text-[11px] font-medium text-[var(--brand-text)]">
            <i class="fas fa-sliders-h text-base mb-0.5" style="color: var(--brand-accent);"></i>Filtros
        </button>
        <button id="open-sort-btn" class="flex flex-col items-center text-[11px] font-medium text-[var(--brand-text)]">
            <i class="fas fa-sort-amount-down text-base mb-0.5" style="color: var(--brand-accent);"></i>Ordenar
        </button>
        <a href="#product-list-section" class="flex flex-col items-center text-[11px] font-medium text-[var(--brand-text)]">
            <i class="fas fa-th-large text-base mb-0.5" style="color: var(--brand-accent);"></i>Productos
        </a>
    </div>

    <!-- Panel off-canvas filtros -->
    <div id="mobile-filters-panel" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40" id="filters-backdrop"></div>
        <div class="absolute bottom-0 left-0 right-0 max-h-[80%] bg-white rounded-t-3xl shadow-xl flex flex-col animate-slide-up" id="mobile-filters-shell">
            <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
                <h4 class="text-lg font-bold flex items-center gap-2" style="color: var(--brand-accent);">
                    <i class="fas fa-sliders-h"></i> Filtros
                </h4>
                <button id="close-filters-btn" class="text-gray-500 text-xl leading-none" aria-label="Cerrar panel">&times;</button>
            </div>
            <!-- Herramientas extra (solo móvil) -->
            <div id="mobile-filters-tools" class="p-4 pb-2 border-b bg-white space-y-3">
                <div>
                    <label for="mobile-cat-search" class="text-xs font-semibold uppercase tracking-wide text-gray-500">Buscar categoría</label>
                    <input id="mobile-cat-search" type="search" placeholder="Escribe para filtrar..." class="mt-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" />
                </div>
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">Activos</p>
                    <div id="active-filters-summary" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="overflow-y-auto p-4 flex-1" id="mobile-filters-content" aria-label="Listado de filtros" tabindex="0"></div>
            <div id="mobile-filters-footer" class="p-4 border-t bg-white flex gap-3 sticky bottom-0">
                <button id="clear-filters-btn" class="flex-1 border border-pink-300 text-pink-600 font-semibold py-2 rounded-full text-sm hover:bg-pink-50 transition">Limpiar</button>
                <button id="apply-filters-btn" class="flex-1 bg-[var(--brand-accent)] text-white font-semibold py-2 rounded-full text-sm hover:opacity-90 transition">Aplicar</button>
            </div>
        </div>
    </div>



<!-- 
 =======================================================================
 CONTENIDO PRINCIPAL (Sidebar y Lista de Productos)
 =======================================================================
-->
<div class="container mx-auto px-4 flex flex-col lg:flex-row gap-8 mt-2 sm:mt-8">

    {# Header contextual movido dentro del main para no desplazar el sidebar #}

    <!-- 
      =================================
      SIDEBAR DE FILTROS Y CATEGORÍAS
      =================================
    -->
    <aside id="filters-sidebar" class="hidden lg:block w-full lg:w-72 bg-white shadow-lg rounded-2xl p-6 border lg:sticky top-4 h-max" style="border-color: rgba(var(--brand-primary-rgb), 0.3);">
        <h3 class="font-extrabold text-2xl mb-6 tracking-wide flex items-center gap-2" style="color: var(--brand-accent);">
            <i class="fas fa-list"></i> Categorías
        </h3>

        <ul class="space-y-3">
            <li>
                <a 
                    href="{% url 'catalogo_publico' %}#product-list-section"
                    class="js-category-link block px-3 py-2 rounded-lg text-lg font-bold shadow-sm transition-all hover:underline text-[var(--brand-accent)]"
                    data-filter="categoria" data-value="" onclick="handleFilterClick(event)">
                    Todos
                </a>
            </li>
            {% for cat in categorias_menu %}
                <li>
                    <a 
                        href="?categoria={{ cat.slug }}#product-list-section"
                        class="js-category-link block px-3 py-2 rounded-lg text-lg font-bold shadow-sm transition-all hover:underline text-[var(--brand-accent)]"
                        data-filter="categoria" data-value="{{ cat.slug }}" onclick="handleFilterClick(event)">
                        {{ cat.nombre }}
                    </a>
                    
                    {% if cat.children.all %}
                        <ul class="ml-4 mt-2 space-y-1 pl-3" style="border-left: 2px solid var(--brand-primary);">
                            {% for subcat in cat.children.all %}
                                <li>
                                    <a 
                                        href="?categoria={{ subcat.slug }}#product-list-section"
                                        class="js-category-link block px-2 py-1 rounded text-base transition-all text-[var(--brand-text)]"
                                        data-filter="categoria" data-value="{{ subcat.slug }}" onclick="handleFilterClick(event)">
                                        {{ subcat.nombre }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <div class="mt-10 space-y-6">
            <div>
                <h4 class="font-bold mb-2" style="color: var(--brand-accent);">Filtrar por precio</h4>
                <form id="price-form" class="flex flex-col gap-2">
                    <input type="number" name="precio_min" placeholder="Mín" value="{{ filtros_activos.precio_min|default:'' }}" class="w-full rounded border px-2 py-1">
                    <input type="number" name="precio_max" placeholder="Máx" value="{{ filtros_activos.precio_max|default:'' }}" class="w-full rounded border px-2 py-1">
                    <button id="price-filter-btn" type="submit" class="w-full mt-2 rounded px-4 py-1 text-white transition-all flex items-center justify-center" style="background-color: var(--brand-accent);">
                        <span class="btn-text">Aplicar</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden btn-loader"></i>
                    </button>
                </form>
            </div>
        </div>
    </aside>

    <!-- 
      =================================
      CONTENIDO PRINCIPAL (PRODUCTOS)
      =================================
    -->
    <main class="flex-1">
        {# Header contextual simplificado (SUBIDO encima del título) #}
    <div id="banner-context-header" class="sticky z-40 bg-white/90 backdrop-blur border-b border-pink-200 shadow-sm px-4 sm:px-6 py-2 flex items-center gap-3 top-[82px] md:top-[84px]" style="top:82px;">
            {% if banner and not producto_unico and mostrar_titulo_banner %}
                <h3 class="text-base sm:text-lg font-extrabold font-brand" style="color: var(--brand-accent);">{{ banner.titulo }}</h3>
            {% endif %}
            <span id="matched-counter-pill" role="status" aria-live="polite" class="counter-pill text-xs sm:text-sm font-semibold inline-flex items-center gap-1 needs-urgency-eval{% if matched_count <= 8 %} pre-urgency{% endif %}" style="color: var(--brand-accent);" data-matched-count="{{ matched_count }}">
                <i class="fas fa-box-open text-[var(--brand-accent)] text-xs"></i>
                <span class="counter-label hidden sm:inline">Productos:</span>
                <span class="counter-number">{{ matched_count }}</span>
                <span class="urgency-msg ml-1 text-[9px] sm:text-[10px] font-bold tracking-wide uppercase hidden"></span>
            </span>
        </div>
    <div class="products-header flex flex-col sm:flex-row justify-between items-center mb-3 sm:mb-8 gap-3">
            <h2 id="products-heading" class="text-4xl font-brand w-full" style="color: var(--brand-text);" tabindex="-1">Nuestros Productos</h2>
            <div class="flex items-center gap-4 w-full sm:w-auto justify-start sm:justify-end">
                <label for="sort-by" class="font-semibold whitespace-nowrap">Ordenar por:</label>
                <select id="sort-by" name="orden" class="rounded-full border-gray-300 shadow-sm" style="--tw-ring-color: var(--brand-accent);">
                    <option value="default" {% if not filtros_activos.orden or filtros_activos.orden == 'default' %}selected{% endif %}>Relevancia</option>
                    <option value="price-asc" {% if filtros_activos.orden == 'price-asc' %}selected{% endif %}>Precio: Menor a Mayor</option>
                    <option value="price-desc" {% if filtros_activos.orden == 'price-desc' %}selected{% endif %}>Precio: Mayor a Menor</option>
                </select>
            </div>
            <!-- Contador móvil sticky vuelve al header original; duplicado eliminado -->
        </div>
            <!-- Offset dinámico eliminado: se quita espacio adicional superior -->

        <div id="product-list-section" aria-live="polite" aria-busy="false">
            <template id="list-skeleton">
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                {% for i in '12345678' %}
                <div class="skeleton-card relative rounded-xl overflow-hidden bg-white shadow-sm">
                  <div class="skeleton-img shimmer"></div>
                  <div class="p-3 space-y-2">
                    <div class="skeleton-line shimmer w-5/6 h-3"></div>
                    <div class="skeleton-line shimmer w-2/3 h-3"></div>
                    <div class="skeleton-price shimmer w-1/3 h-4 mt-3"></div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </template>
            {% include 'partials/_product_list_ajax.html' %}
        </div>
    </main>

</div>

{% endblock %}

{% block extra_js %}
<script>
// Countdown simple para banners
document.addEventListener('DOMContentLoaded', function(){
    // Contador con segundos y animación simple
    document.querySelectorAll('.countdown[data-fecha-fin]').forEach(function(el){
        const end = new Date(el.getAttribute('data-fecha-fin'));
        const parent = el.closest('.countdown-badge');
        const message = parent ? parent.querySelector('.countdown-message') : null;

        function fmt(n){ return String(n).padStart(2,'0'); }

        function tick(){
            const now = new Date();
            const diff = end - now;
            if(diff <= 0){
                el.textContent = '00:00:00';
                if(message) message.textContent = '¡Oferta terminada!';
                if(parent) parent.classList.add('opacity-50');
                return;
            }

            const totalSeconds = Math.floor(diff / 1000);
            const days = Math.floor(totalSeconds / 86400);
            const hours = Math.floor((totalSeconds % 86400) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            // Formato preferible: si hay días mostramos D HH:MM:SS, si no HH:MM:SS
            const timeStr = (days > 0) ? `${days}d ${fmt(hours)}:${fmt(minutes)}:${fmt(seconds)}` : `${fmt(hours)}:${fmt(minutes)}:${fmt(seconds)}`;
            el.textContent = timeStr;

            // Mostrar mensaje de urgencia cuando falten < 5 minutos
            if(message){
                if(totalSeconds <= 300){
                    message.style.display = 'block';
                    message.textContent = 'Apresúrate, la oferta termina pronto.';
                    // simple pulso para urgencia
                    el.classList.add('pulse-urgent');
                } else {
                    message.style.display = 'none';
                    el.classList.remove('pulse-urgent');
                }
            }

            // update every 1s
            setTimeout(tick, 1000);
        }
        tick();
    });

    // estilos dinámicos mínimos para el pulso (inserción directa por facilidad)
    const style = document.createElement('style');
    style.textContent = `
    .pulse-urgent{ animation: pulse 1s infinite; }
    @keyframes pulse{ 0%{ transform: scale(1); } 50%{ transform: scale(1.05); } 100%{ transform: scale(1); } }
    .countdown-badge{ transition: transform .2s ease, opacity .2s ease; }
    `;
    document.head.appendChild(style);
});

// (Eliminado soporte de enlaces con ?productos= del banner)

    let productListContainer;
    let skeleton;

    async function updateProducts(url, formButton = null) {
        if(window.BANNER_FILTERED){
            console.debug('updateProducts abortado: modo banner filtrado activo');
            return;
        }
        if (!productListContainer) productListContainer = document.getElementById('product-list-section');
        const tpl = document.getElementById('list-skeleton');
        if(tpl){
          productListContainer.setAttribute('aria-busy','true');
          productListContainer.innerHTML = tpl.innerHTML;
        }
        if (formButton) { formButton.disabled = true; formButton.querySelector('.btn-text').classList.add('hidden'); formButton.querySelector('.btn-loader').classList.remove('hidden'); }
        try {
            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const html = await response.text();
            productListContainer.innerHTML = html;
            if(productListContainer.querySelector('html')){ const parser = new DOMParser(); const doc = parser.parseFromString(html,'text/html'); const extracted = doc.querySelector('#product-list-section'); if(extracted){ productListContainer.innerHTML = extracted.innerHTML; } }
            const heading = document.getElementById('products-heading'); if (heading) heading.focus();
            (function(){
                const pill = document.getElementById('matched-counter-pill');
                if(!pill) return; const count = productListContainer.querySelectorAll('.product-card').length; const numEl = pill.querySelector('.counter-number'); if(numEl) numEl.textContent = count; pill.setAttribute('data-matched-count', count); if(window.updateUrgencyPill){ window.updateUrgencyPill(count); } pill.classList.remove('bump'); void pill.offsetWidth; pill.classList.add('bump');
            })();
            if(window.innerWidth < 640){ setTimeout(()=>{ const section = document.querySelector('#product-list-section'); if(section){ section.scrollIntoView({behavior:'smooth', block:'start'}); } }, 50); }
            // initQuickAdd() eliminado (ya no usamos botón de añadir rápido aquí)
            // Evitar error si la función de prefetch no está definida
            if (typeof prefetchNextPage === 'function') {
                prefetchNextPage();
            }
            // Refuerzo: re-sincronizar resaltado tras carga (por si wrapper no se montó aún)
            try { const p=new URL(url, window.location.origin); const slug=p.searchParams.get('categoria')||''; if(window.setActiveCategory) window.setActiveCategory(slug); } catch(e){}
        } catch (error) {
            console.error('Error al actualizar los productos:', error);
            productListContainer.innerHTML = '<p class="text-center text-red-500 py-10">Hubo un error al cargar los productos.</p>';
        } finally {
            if (formButton) { formButton.disabled = false; formButton.querySelector('.btn-text').classList.remove('hidden'); formButton.querySelector('.btn-loader').classList.add('hidden'); }
            productListContainer.setAttribute('aria-busy','false');
        }
    }

    function handleStateChange(params, formButton = null) {
        params.set('page', '1');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.pushState({}, '', newUrl);
        updateProducts(newUrl, formButton);
    // Actualizar resumen de filtros si existe
    if (window.buildFilterChips) { window.buildFilterChips(); }
    // Actualizar resaltado de categorías
    const catSlug = params.get('categoria') || '';
    setActiveCategory(catSlug);
    setMobileCounterLoading();
    }

    function handleFilterClick(event) {
        event.preventDefault();
        
        const link = event.currentTarget;
        const filterType = link.dataset.filter;
        const filterValue = link.dataset.value;

        const params = new URLSearchParams(window.location.search);
        
        if (filterValue) {
            params.set(filterType, filterValue);
        } else {
            params.delete(filterType);
        }
        
        handleStateChange(params);
    // (Resaltado gestionado por regla única)
    }

    document.addEventListener('DOMContentLoaded', () => {
        productListContainer = document.getElementById('product-list-section');
        skeleton = document.getElementById('list-skeleton');

        const sortBySelect = document.getElementById('sort-by');
        const priceForm = document.getElementById('price-form');

        // Handler común de orden (funciona en ambos modos)
        if (sortBySelect) {
            sortBySelect.addEventListener('change', () => {
                const params = new URLSearchParams(window.location.search);
                params.set('orden', sortBySelect.value);
                const dest = `${window.location.pathname}?${params.toString()}#product-list-section`;
                if (window.BANNER_FILTERED) {
                    // Modo banner: recarga completa para mantener consistencia con render del servidor
                    window.location.href = dest;
                } else {
                    handleStateChange(params);
                }
            });
        }

        // Si modo banner filtrado: no configurar AJAX adicional para mantener estado coherente
        if (window.BANNER_FILTERED) {
            console.debug('Banner-filtered mode: handlers AJAX desactivados (orden hace full reload)');
            if (priceForm) {
                priceForm.addEventListener('submit', (e)=>{
                    e.preventDefault();
                    const formData = new FormData(priceForm);
                    const params = new URLSearchParams(window.location.search);
                    params.set('precio_min', formData.get('precio_min') || '');
                    params.set('precio_max', formData.get('precio_max') || '');
                    window.location.href = `${window.location.pathname}?${params.toString()}#product-list-section`;
                });
            }
            return;
        }

        // --- Modo normal (AJAX) ---
        if (priceForm) {
            priceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(priceForm);
                const params = new URLSearchParams(window.location.search);
                params.set('precio_min', formData.get('precio_min') || '');
                params.set('precio_max', formData.get('precio_max') || '');
                handleStateChange(params, e.currentTarget.querySelector('button'));
            });
        }

        if (productListContainer) {
            productListContainer.addEventListener('click', (e) => {
                const pageLink = e.target.closest('nav a');
                if (!pageLink) return;
                e.preventDefault();
                const url = pageLink.getAttribute('href');
                if (url) {
                    history.pushState({}, '', url);
                    updateProducts(url);
                }
            });
        }

        window.addEventListener('popstate', () => {
            updateProducts(window.location.href);
            if (window.buildFilterChips) { window.buildFilterChips(); }
            const params = new URLSearchParams(window.location.search);
            setActiveCategory(params.get('categoria')||'');
            setMobileCounterLoading();
        });

        // Estado inicial de categoría activa
        const initParams = new URLSearchParams(window.location.search);
        setActiveCategory(initParams.get('categoria')||'');
    updateMobileProductsCounter();

        // --- Comportamiento del contador en móvil: aparece al hacer scroll hacia arriba ---
        try {
            const mq = window.matchMedia('(max-width: 640px)');
            const header = document.querySelector('header');
            const counterBar = document.getElementById('banner-context-header');
            let lastY = window.scrollY;
            let ticking = false;
            function updateTop(){
                if(!counterBar || !header) return;
                const top = header.getBoundingClientRect().height;
                // Subimos 29px (10px más respecto al ajuste anterior)
                const adjusted = Math.max(48, Math.round(top - 29));
                document.documentElement.style.setProperty('--catalog-counter-top', `${adjusted}px`);
            }
            function onScroll(){
                const y = window.scrollY;
                const scrollingUp = y < lastY - 4; // margen mínimo
                if(mq.matches){
                    if(scrollingUp && y > 10){ counterBar.classList.add('floating'); }
                    else { counterBar.classList.remove('floating'); }
                } else {
                    counterBar.classList.remove('floating');
                }
                lastY = y;
            }
            if(mq.matches){ updateTop(); }
            window.addEventListener('resize', updateTop);
            window.addEventListener('orientationchange', updateTop);
            window.addEventListener('scroll', ()=>{ if(!ticking){ requestAnimationFrame(()=>{ onScroll(); ticking=false; }); ticking=true; }}, {passive:true});
        } catch(e) { console.debug('contador flotante init error', e); }
    });
</script>
<script>
// ==== Stubs / Utilidades de respaldo para evitar errores en móvil ====
// Algunas funciones eran llamadas pero no estaban definidas en ningún script
// global, provocando ReferenceError y disparando el catch que muestra:
// "Hubo un error al cargar los productos." al filtrar.
(function(){
    // Marcar categoría activa en sidebar y chips móviles
    // (setActiveCategory definido en regla única superior; no redefinir)

    // Mostrar estado de "cargando" en el contador móvil (placeholder simple)
    if (typeof window.setMobileCounterLoading !== 'function') {
        window.setMobileCounterLoading = function(){
            const pill = document.getElementById('matched-counter-pill');
            if(pill){ pill.classList.add('opacity-60'); }
            setTimeout(()=>{ if(pill) pill.classList.remove('opacity-60'); }, 600);
        };
    }

    // Recalcular contador de productos (mobile & desktop)
    if (typeof window.updateMobileProductsCounter !== 'function') {
        window.updateMobileProductsCounter = function(){
            try {
                const count = document.querySelectorAll('#product-list-section .product-card').length;
                const pill = document.getElementById('matched-counter-pill');
                if(pill){
                    const numEl = pill.querySelector('.counter-number');
                    if(numEl) numEl.textContent = count;
                    pill.setAttribute('data-matched-count', count);
                    if(typeof window.updateUrgencyPill === 'function'){ window.updateUrgencyPill(count); }
                }
            } catch(e){ console.debug('updateMobileProductsCounter stub error', e); }
        };
    }

    // Prefetch de la siguiente página de paginación (stub no-op para ahora)
    if (typeof window.prefetchNextPage !== 'function') {
        window.prefetchNextPage = function(){ /* no-op stub */ };
    }
})();
</script>
        <script>
        // --- UX móvil: panel off-canvas filtros y chips ---
        document.addEventListener('DOMContentLoaded', ()=>{
            const openBtn = document.getElementById('open-filters-btn');
            const panel = document.getElementById('mobile-filters-panel');
            if(!openBtn || !panel) return;
            const backdrop = document.getElementById('filters-backdrop');
            const closeBtn = document.getElementById('close-filters-btn');
            const sidebar = document.getElementById('filters-sidebar');
            const target = document.getElementById('mobile-filters-content');
            const searchInput = document.getElementById('mobile-cat-search');
            const summary = document.getElementById('active-filters-summary');
            const clearBtn = document.getElementById('clear-filters-btn');
            const applyBtn = document.getElementById('apply-filters-btn');
            if(sidebar && target){ target.innerHTML = sidebar.innerHTML; }
            function open(){ panel.classList.remove('hidden'); document.documentElement.classList.add('overflow-hidden'); }
            function close(){ panel.classList.add('hidden'); document.documentElement.classList.remove('overflow-hidden'); }
            openBtn.addEventListener('click', open);
            backdrop && backdrop.addEventListener('click', close);
            closeBtn && closeBtn.addEventListener('click', close);
                target && target.addEventListener('click', e=>{ if(e.target.closest("a,button[type='submit']")){ setTimeout(close, 200); } });
            document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !panel.classList.contains('hidden')) close(); });

            // --- Construir chips de filtros activos ---
            function buildFilterChips(){
                if(!summary) return;
                summary.innerHTML = '';
                const params = new URLSearchParams(window.location.search);
                const mapping = {
                    'categoria':'Cat',
                    'precio_min':'Min',
                    'precio_max':'Max',
                    'orden':'Ord'
                };
                let any=false;
                params.forEach((val,key)=>{
                    if(!mapping[key] || !val) return;
                    any=true;
                    const chip=document.createElement('button');
                    chip.type='button';
                    chip.className='px-2 py-1 rounded-full bg-pink-100 text-pink-700 text-xs font-semibold flex items-center gap-1';
                    chip.innerHTML = `<span>${mapping[key]}: ${val}</span><span aria-hidden="true">&times;</span>`;
                    chip.addEventListener('click',()=>{
                        params.delete(key);
                        const newUrl = `${window.location.pathname}?${params.toString()}#product-list-section`;
                        if(window.BANNER_FILTERED){ window.location.href=newUrl; } else { history.pushState({},'',newUrl); updateProducts(newUrl); }
                        buildFilterChips();
                        if(key==='categoria'){ setActiveCategory(''); }
                    });
                    summary.appendChild(chip);
                });
                if(!any){ summary.innerHTML = '<span class="text-gray-400 text-xs">Ninguno</span>'; }
            }
            buildFilterChips();
            // Exponer global para otras funciones
            window.buildFilterChips = buildFilterChips;

            // --- Buscador de categorías ---
            if(searchInput){
                searchInput.addEventListener('input',()=>{
                    const q = searchInput.value.trim().toLowerCase();
                    const links = target.querySelectorAll('a.js-category-link');
                    links.forEach(a=>{
                        if(!q){ a.classList.remove('opacity-30','hidden'); return; }
                        const match = a.textContent.trim().toLowerCase().includes(q);
                        a.classList.toggle('hidden', !match);
                    });
                    // Ocultar <li> padres si todos sus enlaces están ocultos
                    target.querySelectorAll('li').forEach(li=>{
                        const anyVisible = [...li.querySelectorAll('a.js-category-link')].some(l=>!l.classList.contains('hidden'));
                        li.classList.toggle('hidden', !anyVisible && q!=='' );
                    });
                });
            }

            // --- Botones footer ---
            clearBtn && clearBtn.addEventListener('click', ()=>{
                const base = window.location.pathname + '#product-list-section';
                window.location.href = base;
            });
            applyBtn && applyBtn.addEventListener('click', ()=>{
                // reenviar form de precios si existe; si no, simplemente cerrar
                const priceForm = target.querySelector('#price-form');
                if(priceForm){
                    const btn = priceForm.querySelector('button');
                    if(window.BANNER_FILTERED){ priceForm.submit(); }
                    else {
                        const formData = new FormData(priceForm);
                        const params = new URLSearchParams(window.location.search);
                        params.set('precio_min', formData.get('precio_min') || '');
                        params.set('precio_max', formData.get('precio_max') || '');
                        handleStateChange(params, btn);
                    }
                }
                close();
            });
            // Delegar click de categorías dentro del panel para actualizar chips al instante
            target && target.addEventListener('click', e=>{
                const link = e.target.closest('a.js-category-link');
                if(!link) return;
                // Cerrar de inmediato para sensación rápida
                const panel = document.getElementById('mobile-filters-panel');
                if(panel){ panel.classList.add('hidden'); document.documentElement.classList.remove('overflow-hidden'); }
                const val = link.dataset.value || '';
                if(window.buildFilterChips) window.buildFilterChips();
                setActiveCategory(val);
            });
        });
        </script>
        <style>
        #mobile-category-chips .no-scrollbar::-webkit-scrollbar{display:none}
        #mobile-category-chips .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
        @keyframes slide-up{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
        .animate-slide-up{animation:slide-up .25s ease}
        /* Shimmer skeleton */
.skeleton-img{height:120px;background:#f3f3f3;border-bottom:1px solid #eee;}
.skeleton-line,.skeleton-price{background:#f3f3f3;border-radius:6px;}
.shimmer{position:relative;overflow:hidden;}
.shimmer:after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(110deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.7) 40%,rgba(255,255,255,0) 80%);animation:shimmer 1.1s infinite;}
@keyframes shimmer{100%{transform:translateX(100%);}}

/* (Estilos quick add eliminados) */

/* Animaciones hero móviles */
.hero-animate{overflow:hidden;position:relative;}
.hero-overlay{background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.35) 30%,rgba(0,0,0,.55));animation:fadeIn .9s ease both;}
.hero-content{animation:riseIn .9s cubic-bezier(.22,.9,.3,1) .15s both;}
.hero-title{background:linear-gradient(90deg,#fff,#ffe4f2 60%,#fff);-webkit-background-clip:text;background-clip:text;color:transparent;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4));animation:titleGlow 4.5s ease-in-out infinite;}
.hero-sub{opacity:0;animation:fadeIn .9s ease .35s forwards;}
.hero-cta{position:relative;overflow:hidden;}
.hero-cta:before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.35),rgba(255,255,255,0) 70%);opacity:0;transition:opacity .5s;}
.hero-cta:hover:before{opacity:.9;}
.hero-countdown-wrapper{animation:fadeIn .9s ease .55s both;}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
@keyframes riseIn{0%{opacity:0;transform:translateY(30px) scale(.98);}60%{opacity:1;}100%{opacity:1;transform:translateY(0) scale(1);} }
@keyframes titleGlow{0%,100%{filter:drop-shadow(0 2px 6px rgba(0,0,0,.4)) brightness(1);}50%{filter:drop-shadow(0 4px 10px rgba(0,0,0,.55)) brightness(1.15);} }
/* Partículas ligeras */
.hero-animate .particle{position:absolute;top:0;left:0;width:6px;height:6px;background:radial-gradient(circle,#fff,#ffc1e3);border-radius:50%;opacity:0;animation:float 6s linear infinite;mix-blend-mode:screen;}
@keyframes float{0%{transform:translate3d(var(--xStart),var(--yStart),0) scale(.4);opacity:0}10%{opacity:.9}85%{opacity:.9}100%{transform:translate3d(var(--xEnd),var(--yEnd),0) scale(1);opacity:0}}
@media (max-width:640px){.hero-animate{height:42vh!important;min-height:260px;} }
</style>
<!-- Bloque residual de quick add y prefetch eliminado -->
</script>
<style>
/* Estado visual consistente para chip activo (corrige que se quede resaltado al cambiar a "Todos") */
#mobile-category-chips a.chip-active{
    background-color: rgba(var(--brand-primary-rgb),0.15) !important;
    border:1px solid var(--brand-accent) !important;
    color: var(--brand-accent) !important;
}
/* Compactación móvil adicional */
@media (max-width: 640px){
    /* Evitar solape inferior con la barra fija */
    body.catalog-page main{ padding-bottom: 64px; }
    /* Chips más compactos */
    #mobile-category-chips a{ font-size: 12px; padding: 6px 10px; border-radius: 9999px; white-space: nowrap; }
    /* Modo flotante (se activa solo al desplazarse hacia arriba) */
    #banner-context-header.floating{ position: fixed; left: 0; right: 0; top: var(--catalog-counter-top, 84px); z-index: 45; }
    /* Compactar el propio header de conteo para ahorrar espacio */
    #banner-context-header{ padding-top: .25rem; padding-bottom: .25rem; }
    /* Barra inferior: respetar safe-area en iOS */
    #mobile-action-bar{ padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 2px); }
}
</style>
<!-- Script de auto-ocultado de la barra inferior móvil eliminado a solicitud: ahora siempre visible -->
<script>
// Función global para mensaje de urgencia SOLO móvil (revisada)
window.updateUrgencyPill = function(count){
    ['matched-counter-pill','matched-counter-pill-mobile'].forEach(id=>{
        const pill=document.getElementById(id); if(!pill) return;
        const msgEl=pill.querySelector('.urgency-msg');
        const w = window.innerWidth || document.documentElement.clientWidth || screen.width;
        // Solo mostrar mensaje de urgencia en móvil (<=768)
        if(w>768 && id==='matched-counter-pill-mobile'){ return; }
        if(w>768 && id==='matched-counter-pill'){ // desktop: mantener comportamiento original (podrías decidir ocultar también)
            if(msgEl){msgEl.classList.add('hidden'); msgEl.textContent='';}
            pill.classList.remove('urgency','urgency-hot'); return;
        }
        let text=''; let mode='';
        if(count>0 && count<=4){ text='¡Últimas unidades!'; mode='hot'; }
        else if(count>0 && count<=8){ text='Stock limitado'; mode='warn'; }
        else if(count===0){ text='Sin stock'; mode='warn'; }
        if(text){
            if(msgEl){ msgEl.textContent=text; msgEl.classList.remove('hidden'); }
            pill.classList.add('urgency');
            if(mode==='hot') pill.classList.add('urgency-hot'); else pill.classList.remove('urgency-hot');
        } else {
            if(msgEl){ msgEl.classList.add('hidden'); msgEl.textContent=''; }
            pill.classList.remove('urgency','urgency-hot');
        }
    });
};
// Inicial en carga + fallback diferido
function __initUrgency(){
    const mainPill=document.getElementById('matched-counter-pill');
    const mobilePill=document.getElementById('matched-counter-pill-mobile');
    const apply=(pill)=>{ if(!pill) return; const c=parseInt(pill.getAttribute('data-matched-count')|| pill.querySelector('.counter-number')?.textContent ||'0'); window.updateUrgencyPill(c); pill.classList.remove('needs-urgency-eval'); };
    apply(mainPill); apply(mobilePill);
    // Sincronizar números si existen ambos
    if(mainPill && mobilePill){ const val = mainPill.querySelector('.counter-number')?.textContent; if(val) mobilePill.querySelector('.counter-number').textContent=val; }
}
document.addEventListener('DOMContentLoaded',()=>{ setTimeout(__initUrgency,10); setTimeout(__initUrgency,500); });
// Observer por si AJAX cambia el número y no se disparó update
// Eliminados observers recursivos para evitar loop; sincronización se hará explícitamente al actualizar productos.
// Re-evaluar al redimensionar
window.addEventListener('resize',()=>{ ['matched-counter-pill','matched-counter-pill-mobile'].forEach(id=>{ const pill=document.getElementById(id); if(pill){ const c=parseInt(pill.getAttribute('data-matched-count')||pill.querySelector('.counter-number')?.textContent||'0'); window.updateUrgencyPill(c); } }); });
</script>
<!-- Bloque duplicado de resaltado coherente eliminado (regla única ya definida arriba) -->
<!-- 
  =======================================================================
  MEJORAS Y OPTIMIZACIONES VARIAS
  =======================================================================
-->
{% comment %} Sección de mejoras y optimizaciones varias {% endcomment %}
{% if false %} {# Ocultar sección de mejoras #} {% endif %}
<!-- Vista rápida eliminada (sección placeholder removida por solicitud) -->
{% endblock extra_js %}
