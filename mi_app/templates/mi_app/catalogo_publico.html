{% extends 'base.html' %}
{% load static %}

{% block body_class %}catalog-page{% endblock %}

{% block title %}Catálogo - {{ block.super }}{% endblock %}

{% block content %}

<script>
    // Flag del servidor que indica que la vista fue cargada desde un banner
    // Flag inicial enviado por el servidor: incluye productos=, solo_ofertas=1 o categoria=nueva_coleccion
    window.BANNER_FILTERED = {{ banner_mode_active|yesno:'true,false' }};
// -------------------------------------------------------------
// MODO FILTRO POR BANNER (productos=): desactivar AJAX y paginación dinámica
// -------------------------------------------------------------
(function(){
    if(window.BANNER_FILTERED) return; // ya establecido desde el servidor
    const params = new URLSearchParams(window.location.search);
    if(params.get('productos') || params.get('solo_ofertas') === '1' || params.get('categoria') === 'nueva_coleccion'){
        window.BANNER_FILTERED = true;
        document.addEventListener('DOMContentLoaded', ()=>{ document.body.classList.add('banner-filtered-mode'); });
    }
})();
</script>

<script>
// Forzar navegación completa en banner (por si algún handler global intercepta)
document.addEventListener('click', function(e){
    const a = e.target.closest && e.target.closest('a.banner-cta');
    if(!a) return;
    const href = a.getAttribute('href')||'';
    if(href.includes('solo_ofertas=1')){
        // desactivar cualquier bandera ajax y hacer location directa
        window.BANNER_FILTERED = true;
        window.location.href = href.replace('#product-list-section','')+ '#product-list-section';
        e.preventDefault();
    }
});
</script>

<!-- 
 =======================================================================
 HERO BANNER
 =======================================================================
-->
{# Hero dinámico: se muestra el primer banner activo; si no hay, hero por defecto. #}
{% if banners_activos and banners_activos|length > 0 %}
    {% with b=banners_activos.0 %}
    <section 
        class="relative w-full h-64 sm:h-80 flex items-center justify-center text-white bg-gray-400"
        style="background-image: url('{{ b.imagen_url }}'); background-size: cover; background-position: center;"
        role="img"
        aria-label="{{ b.titulo }}">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative text-center p-4">
            <h1 class="text-4xl sm:text-6xl md:text-7xl font-brand drop-shadow-lg">{{ b.titulo }}</h1>
            {% if b.subtitulo %}
                <p class="mt-2 text-lg sm:text-xl drop-shadow-md">{{ b.subtitulo }}</p>
            {% endif %}
            <a 
                href="{{ b.destino_url|default:'#product-list-section' }}" 
                class="banner-cta mt-6 inline-block text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-opacity-90 transform hover:scale-105 transition-all"
                style="background-color: var(--brand-accent);">
                {{ b.texto_boton }}
            </a>
            {% if b.fecha_fin %}
                <div class="mt-4">
                        <div class="countdown-badge inline-flex items-center gap-3" aria-live="polite">
                            <span class="countdown-label text-xs uppercase tracking-wide" style="background-color: var(--brand-accent); color: #fff; padding:4px 8px; border-radius:6px;">Tiempo restante</span>
                            <div class="countdown text-xl font-extrabold px-3 py-1 rounded-lg" style="background-color: #fff; color: var(--brand-accent);" data-fecha-fin="{{ b.fecha_fin|date:'c' }}"></div>
                        </div>
                        <p class="countdown-message mt-2 text-sm font-semibold" style="display:none; color: #fff;">Apresúrate, la oferta termina pronto.</p>
                </div>
            {% endif %}
        </div>
    </section>
    {% endwith %}
{% else %}
    <section class="hero-banner relative w-full h-64 sm:h-80 flex items-center justify-center text-white">
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="relative text-center p-4">
            <h1 class="text-4xl sm:text-6xl md:text-7xl font-brand drop-shadow-lg">Nueva Colección</h1>
            <p class="mt-2 text-lg sm:text-xl drop-shadow-md">Descubre la sensualidad en cada detalle</p>
            <a 
                href="?categoria=nueva_coleccion#product-list-section" 
                class="js-category-link mt-6 inline-block text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-opacity-90 transform hover:scale-105 transition-all"
                data-filter="categoria" data-value="nueva_coleccion" onclick="handleFilterClick(event)"
                style="background-color: var(--brand-accent);">
                Ver ahora
            </a>
        </div>
    </section>
{% endif %}


<!-- 
 =======================================================================
 CONTENIDO PRINCIPAL (Sidebar y Lista de Productos)
 =======================================================================
-->
<div class="container mx-auto px-4 flex flex-col lg:flex-row gap-8 mt-8">

    {# Header contextual movido dentro del main para no desplazar el sidebar #}

    <!-- 
      =================================
      SIDEBAR DE FILTROS Y CATEGORÍAS
      =================================
    -->
    <aside id="filters-sidebar" class="w-full lg:w-72 bg-white shadow-lg rounded-2xl p-6 border lg:sticky top-4 h-max" style="border-color: rgba(var(--brand-primary-rgb), 0.3);">
        <h3 class="font-extrabold text-2xl mb-6 tracking-wide flex items-center gap-2" style="color: var(--brand-accent);">
            <i class="fas fa-list"></i> Categorías
        </h3>

        <ul class="space-y-3">
            <li>
                <a 
                    href="{% url 'catalogo_publico' %}#product-list-section"
                    class="js-category-link block px-3 py-2 rounded-lg text-lg font-bold shadow-sm transition-all hover:underline"
                    style="color: var(--brand-accent); {% if not filtros_activos.categoria %}background-color: rgba(var(--brand-primary-rgb), 0.2); border: 1px solid var(--brand-primary);{% endif %}"
                    data-filter="categoria" data-value="" onclick="handleFilterClick(event)">
                    Todos
                </a>
            </li>
            {% for cat in categorias_menu %}
                <li>
                    <a 
                        href="?categoria={{ cat.slug }}#product-list-section"
                        class="js-category-link block px-3 py-2 rounded-lg text-lg font-bold shadow-sm transition-all hover:underline"
                        style="color: var(--brand-accent); {% if filtros_activos.categoria == cat.slug %}background-color: rgba(var(--brand-primary-rgb), 0.2); border: 1px solid var(--brand-primary);{% endif %}"
                        data-filter="categoria" data-value="{{ cat.slug }}" onclick="handleFilterClick(event)">
                        {{ cat.nombre }}
                    </a>
                    
                    {% if cat.children.all %}
                        <ul class="ml-4 mt-2 space-y-1 pl-3" style="border-left: 2px solid var(--brand-primary);">
                            {% for subcat in cat.children.all %}
                                <li>
                                    <a 
                                        href="?categoria={{ subcat.slug }}#product-list-section"
                                        class="js-category-link block px-2 py-1 rounded text-base transition-all"
                                        style="color: var(--brand-text); {% if filtros_activos.categoria == subcat.slug %}background-color: rgba(var(--brand-primary-rgb), 0.2); color: var(--brand-accent); font-weight: 600;{% endif %}"
                                        data-filter="categoria" data-value="{{ subcat.slug }}" onclick="handleFilterClick(event)">
                                        {{ subcat.nombre }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

        <div class="mt-10 space-y-6">
            <div>
                <h4 class="font-bold mb-2" style="color: var(--brand-accent);">Filtrar por precio</h4>
                <form id="price-form" class="flex flex-col gap-2">
                    <input type="number" name="precio_min" placeholder="Mín" value="{{ filtros_activos.precio_min|default:'' }}" class="w-full rounded border px-2 py-1">
                    <input type="number" name="precio_max" placeholder="Máx" value="{{ filtros_activos.precio_max|default:'' }}" class="w-full rounded border px-2 py-1">
                    <button id="price-filter-btn" type="submit" class="w-full mt-2 rounded px-4 py-1 text-white transition-all flex items-center justify-center" style="background-color: var(--brand-accent);">
                        <span class="btn-text">Aplicar</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden btn-loader"></i>
                    </button>
                </form>
            </div>
        </div>
    </aside>

    <!-- 
      =================================
      CONTENIDO PRINCIPAL (PRODUCTOS)
      =================================
    -->
    <main class="flex-1">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <h2 id="products-heading" class="text-4xl font-brand" style="color: var(--brand-text);" tabindex="-1">Nuestros Productos</h2>
            <div class="flex items-center gap-4">
                <label for="sort-by" class="font-semibold whitespace-nowrap">Ordenar por:</label>
                <select id="sort-by" name="orden" class="rounded-full border-gray-300 shadow-sm" style="--tw-ring-color: var(--brand-accent);">
                    <option value="default" {% if not filtros_activos.orden or filtros_activos.orden == 'default' %}selected{% endif %}>Relevancia</option>
                    <option value="price-asc" {% if filtros_activos.orden == 'price-asc' %}selected{% endif %}>Precio: Menor a Mayor</option>
                    <option value="price-desc" {% if filtros_activos.orden == 'price-desc' %}selected{% endif %}>Precio: Mayor a Menor</option>
                </select>
            </div>
        </div>

        {% if banner and not producto_unico %}
            {% if productos_multi or solo_ofertas or banner.modo_destino == 'nueva' %}
                <div class="w-full mb-6 -mt-4" id="banner-context-header">
                    <div class="rounded-2xl px-6 py-4 shadow-md flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4" style="background-color: rgba(var(--brand-primary-rgb,249,168,212),0.25); border:1px solid rgba(var(--brand-primary-rgb,249,168,212),0.5);">
                        <div>
                            <h3 class="text-xl font-extrabold font-brand" style="color: var(--brand-accent);">{{ banner.titulo }}</h3>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-semibold px-3 py-1 rounded-full bg-white shadow" style="color: var(--brand-accent);">Productos: {{ matched_count }}</span>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% elif filtros_activos.categoria == 'nueva_coleccion' %}
            <div class="w-full mb-6 -mt-4" id="banner-context-header">
                <div class="rounded-2xl px-6 py-4 shadow-md flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4" style="background-color: rgba(var(--brand-primary-rgb,249,168,212),0.25); border:1px solid rgba(var(--brand-primary-rgb,249,168,212),0.5);">
                    <div>
                        <h3 class="text-xl font-extrabold font-brand" style="color: var(--brand-accent);">Nueva Colección</h3>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-semibold px-3 py-1 rounded-full bg-white shadow" style="color: var(--brand-accent);">Productos: {{ matched_count }}</span>
                    </div>
                </div>
            </div>
        {% endif %}

        <div id="product-list-section" aria-live="polite">
            {% include 'partials/_product_list_ajax.html' %}
        </div>
    </main>

</div>

{% endblock %}

{% block extra_js %}
<script>
// Countdown simple para banners
document.addEventListener('DOMContentLoaded', function(){
    // Contador con segundos y animación simple
    document.querySelectorAll('.countdown[data-fecha-fin]').forEach(function(el){
        const end = new Date(el.getAttribute('data-fecha-fin'));
        const parent = el.closest('.countdown-badge');
        const message = parent ? parent.querySelector('.countdown-message') : null;

        function fmt(n){ return String(n).padStart(2,'0'); }

        function tick(){
            const now = new Date();
            const diff = end - now;
            if(diff <= 0){
                el.textContent = '00:00:00';
                if(message) message.textContent = '¡Oferta terminada!';
                if(parent) parent.classList.add('opacity-50');
                return;
            }

            const totalSeconds = Math.floor(diff / 1000);
            const days = Math.floor(totalSeconds / 86400);
            const hours = Math.floor((totalSeconds % 86400) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            // Formato preferible: si hay días mostramos D HH:MM:SS, si no HH:MM:SS
            const timeStr = (days > 0) ? `${days}d ${fmt(hours)}:${fmt(minutes)}:${fmt(seconds)}` : `${fmt(hours)}:${fmt(minutes)}:${fmt(seconds)}`;
            el.textContent = timeStr;

            // Mostrar mensaje de urgencia cuando falten < 5 minutos
            if(message){
                if(totalSeconds <= 300){
                    message.style.display = 'block';
                    message.textContent = 'Apresúrate, la oferta termina pronto.';
                    // simple pulso para urgencia
                    el.classList.add('pulse-urgent');
                } else {
                    message.style.display = 'none';
                    el.classList.remove('pulse-urgent');
                }
            }

            // update every 1s
            setTimeout(tick, 1000);
        }
        tick();
    });

    // estilos dinámicos mínimos para el pulso (inserción directa por facilidad)
    const style = document.createElement('style');
    style.textContent = `
    .pulse-urgent{ animation: pulse 1s infinite; }
    @keyframes pulse{ 0%{ transform: scale(1); } 50%{ transform: scale(1.05); } 100%{ transform: scale(1); } }
    .countdown-badge{ transition: transform .2s ease, opacity .2s ease; }
    `;
    document.head.appendChild(style);
});

// (Eliminado soporte de enlaces con ?productos= del banner)

    let productListContainer;
    let skeleton;

    async function updateProducts(url, formButton = null) {
        // Desactivar completamente cuando estamos en modo banner filtrado
        if(window.BANNER_FILTERED){
            console.debug('updateProducts abortado: modo banner filtrado activo');
            return; // no hacer nada; mantenemos render del servidor
        }

        if (!productListContainer || !skeleton) {
            productListContainer = document.getElementById('product-list-section');
            skeleton = document.getElementById('list-skeleton');
        }

        if(skeleton){
            const skeletonHTML = skeleton.outerHTML;
            productListContainer.innerHTML = skeletonHTML;
            const sk = productListContainer.querySelector('#list-skeleton');
            if(sk){ sk.classList.remove('hidden'); }
        }

        // === INICIO DE LA MEJORA: Feedback visual en el botón ===
        if (formButton) {
            formButton.disabled = true;
            formButton.querySelector('.btn-text').classList.add('hidden');
            formButton.querySelector('.btn-loader').classList.remove('hidden');
        }
        // === FIN DE LA MEJORA ===

        try {
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const html = await response.text();
            productListContainer.innerHTML = html;

            const heading = document.getElementById('products-heading');
            if (heading) heading.focus();

        } catch (error) {
            console.error('Error al actualizar los productos:', error);
            productListContainer.innerHTML = '<p class="text-center text-red-500">Hubo un error al cargar los productos.</p>';
        } finally {
            // === INICIO DE LA MEJORA: Restaurar el botón ===
            if (formButton) {
                formButton.disabled = false;
                formButton.querySelector('.btn-text').classList.remove('hidden');
                formButton.querySelector('.btn-loader').classList.add('hidden');
            }
            // === FIN DE LA MEJORA ===
        }
    }

    function handleStateChange(params, formButton = null) {
        params.set('page', '1');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.pushState({}, '', newUrl);
        updateProducts(newUrl, formButton);
    }

    function handleFilterClick(event) {
        event.preventDefault();
        
        const link = event.currentTarget;
        const filterType = link.dataset.filter;
        const filterValue = link.dataset.value;

        const params = new URLSearchParams(window.location.search);
        
        if (filterValue) {
            params.set(filterType, filterValue);
        } else {
            params.delete(filterType);
        }
        
        handleStateChange(params);
    }

    document.addEventListener('DOMContentLoaded', () => {
        productListContainer = document.getElementById('product-list-section');
        skeleton = document.getElementById('list-skeleton');
        if (window.BANNER_FILTERED) {
            console.debug('Banner-filtered mode: no se inicializan handlers AJAX');
            return; // abortar inicialización
        }
        
        const sortBySelect = document.getElementById('sort-by');
        const priceForm = document.getElementById('price-form');

        sortBySelect.addEventListener('change', () => {
            const params = new URLSearchParams(window.location.search);
            params.set('orden', sortBySelect.value);
            handleStateChange(params);
        });

        priceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(priceForm);
            const params = new URLSearchParams(window.location.search);
            params.set('precio_min', formData.get('precio_min') || '');
            params.set('precio_max', formData.get('precio_max') || '');
            handleStateChange(params, e.currentTarget.querySelector('button'));
        });

        productListContainer.addEventListener('click', (e) => {
            const pageLink = e.target.closest('nav a');
            if (!pageLink) return;

            e.preventDefault();
            const url = pageLink.getAttribute('href');
            if (url) {
                history.pushState({}, '', url);
                updateProducts(url);
            }
        });

        window.addEventListener('popstate', () => {
            updateProducts(window.location.href);
        });
    });
</script>
{% endblock extra_js %}
