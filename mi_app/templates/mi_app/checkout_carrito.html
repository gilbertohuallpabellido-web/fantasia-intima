{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
<nav class="text-sm text-gray-500" aria-label="Breadcrumb">
    <ol class="list-none p-0 inline-flex">
        <li class="flex items-center">
            <!-- Breadcrumb de Inicio removido -->
        </li>
        <li class="flex items-center">
            <span class="mx-2">/</span>
            <a href="{% url 'ver_carrito' %}" class="hover:text-[--brand-accent]">Mi Carrito</a>
        </li>
        <li class="flex items-center">
            <span class="mx-2">/</span>
            <span class="font-semibold text-gray-700">Checkout</span>
        </li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    input[type="radio"]:checked + .payment-card {
        border-color: var(--brand-accent);
        background-color: #fdf2f8; /* bg-pink-50 */
        box-shadow: 0 0 0 2px var(--brand-accent);
    }
    /* ===================== */
    /*  Mejora SOLO MÓVIL    */
    /* ===================== */
    /* Variable de altura de la barra inferior */
    body.checkout-page { --mobile-bottom-bar-height: 88px; }
    @media (max-width: 1023px) { /* debajo de lg (Tailwind lg=1024px) */
        .checkout-page {
            padding-bottom: 7rem; /* espacio para la barra fija */
        }
        .checkout-page h1 {
            font-size: 1.9rem; /* reducir encabezados */
        }
        #checkout-form {
            gap: 1.25rem;
        }
        #checkout-form input, #checkout-form select {
            font-size: 0.95rem;
            padding-top: 0.8rem;
            padding-bottom: 0.8rem;
        }
        /* Cards de método de pago más compactas y scroll horizontal si excede */
        .payment-methods-scroll {
            display: flex;
            gap: .75rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: .25rem;
            margin-bottom: .25rem;
        }
        .payment-methods-scroll::-webkit-scrollbar { display: none; }
        .payment-card { min-width: 110px; }
        /* Barra inferior fija */
        #mobile-summary-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: .95rem 1.2rem;
            z-index: 1000; /* mantener por encima del contenido, NO sobre botones (lo elevamos) */
            min-height: 74px;
            left: .75rem;
            right: .75rem;
            width: auto;
            bottom: 72px; /* deja libres los botones flotantes en el borde */
            border-radius: 1.75rem;
            box-shadow: 0 8px 24px -8px rgba(0,0,0,.25), 0 2px 8px -3px rgba(0,0,0,.15);
            border: 1px solid rgba(0,0,0,.05);
        }
        #mobile-summary-bar.show { opacity:1; }
        #mobile-summary-bar .total-label { font-size: .75rem; letter-spacing: .5px; text-transform: uppercase; color:#555; }
        #mobile-summary-bar .total-value { font-size: 1.35rem; font-weight: 700; color: var(--brand-accent); line-height:1; }
        #mobile-summary-bar button {
            flex: 1;
            background: var(--brand-accent);
            color: #fff;
            font-weight: 600;
            padding: .95rem 1rem;
            border-radius: 999px;
            font-size: .95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
        }
        /* Ocultar botón grande original en móvil (ya tenemos barra fija) */
        #submit-button { display: none; }
    /* Ya NO movemos social/chat: elevamos la barra. Ajustar padding inferior del contenido si fuera necesario */
    .checkout-main { padding-bottom: 11rem; }
    }
</style>
{% endblock %}

{% block body_class %}checkout-page{% endblock %}

{% block content %}
<main class="container mx-auto p-4 md:p-8 flex-grow checkout-main checkout-page">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 w-full max-w-6xl mx-auto">
        <!-- Columna de Detalles de Envío y Pago -->
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl">
            <h1 class="text-4xl font-brand text-gray-800 mb-6">Detalles de Envío y Pago</h1>

            <form id="checkout-form" method="post" action="{% url 'procesar_pago' %}" class="space-y-6" onsubmit="handleFormSubmit(event)">
                {% csrf_token %}
                
                <div class="space-y-4">
                    {% if user.is_authenticated and direcciones_usuario %}
                    <div>
                        <label for="direccion_guardada" class="block text-sm font-semibold text-gray-700 mb-1">Usar una dirección guardada</label>
                        <select id="direccion_guardada" onchange="fillAddressForm(this)" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all appearance-none bg-white">
                            <option value="">-- Rellenar manualmente --</option>
                            {% for direccion in direcciones_usuario %}
                            <option value="{{ direccion.id }}" 
                                data-nombre="{{ direccion.destinatario }}"
                                data-direccion="{{ direccion.direccion }}"
                                data-ciudad="{{ direccion.ciudad }}"
                                data-telefono="{{ direccion.telefono }}"
                                data-referencia="{{ direccion.referencia|default:'' }}">
                                {{ direccion.alias }} ({{ direccion.direccion|truncatechars:30 }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div>
                        <label for="nombre" class="block text-sm font-semibold text-gray-700 mb-1">Nombre Completo</label>
                        <input type="text" id="nombre" name="nombre" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required value="{{ initial_data.nombre|default:'' }}">
                    </div>
                    
                    <div>
                        <label for="dni" class="block text-sm font-semibold text-gray-700 mb-1">DNI</label>
                        <input type="text" id="dni" name="dni" placeholder="xxxxxxxx" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-semibold text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="email" id="email" name="email" placeholder="tu_correo@ejemplo.com" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required value="{{ user.email|default:'' }}">
                    </div>

                    <div>
                        <label for="celular" class="block text-sm font-semibold text-gray-700 mb-1">Número de Celular</label>
                        <input type="tel" id="celular" name="celular" placeholder="9xxxxxxxx" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required value="{{ initial_data.telefono|default:'' }}">
                    </div>
                    
                    <div>
                        <label for="direccion" class="block text-sm font-semibold text-gray-700 mb-1">Dirección de Envío</label>
                        <input type="text" id="direccion" name="direccion" class="w-full px-4 py-3 border border-gray-300 rounded-xl" required value="{{ initial_data.direccion|default:'' }}">
                    </div>

                    <div>
                        <label for="referencia" class="block text-sm font-semibold text-gray-700 mb-1">Referencia (Opcional)</label>
                        <input type="text" id="referencia" name="referencia" class="w-full px-4 py-3 border border-gray-300 rounded-xl" value="{{ initial_data.referencia|default:'' }}">
                    </div>
                    
                    <div>
                        <label for="ciudad" class="block text-sm font-semibold text-gray-700 mb-1">Ciudad</label>
                        <select id="ciudad" name="ciudad" class="w-full px-4 py-3 border border-gray-300 rounded-xl" onchange="updateDeliveryInfo(this.value)">
                            <option value="Lima" {% if initial_data.ciudad == 'Lima' %}selected{% endif %}>Lima</option>
                            <option value="Provincia" {% if initial_data.ciudad == 'Provincia' %}selected{% endif %}>Provincia</option>
                        </select>
                    </div>
                </div>
                
                <div class="space-y-4 pt-4 border-t-2 border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Método de Pago</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        
                        <!-- === INICIO DE LA MEJORA: Imágenes de Pago Dinámicas === -->
                        <label class="cursor-pointer">
                            <input type="radio" name="metodo_pago" value="yape" class="hidden" onchange="togglePaymentFields(this.value)" required>
                            <span class="payment-card flex items-center justify-center p-4 bg-gray-50 rounded-xl border-2 border-gray-200 transition-all duration-200 h-20">
                                {% if configuracion_sitio.imagen_yape %}
                                    <img src="{{ configuracion_sitio.imagen_yape.url }}" alt="Yape" class="h-8 object-contain">
                                {% else %}
                                    <span class="font-bold">Yape</span>
                                {% endif %}
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="metodo_pago" value="plin" class="hidden" onchange="togglePaymentFields(this.value)" required>
                            <span class="payment-card flex items-center justify-center p-4 bg-gray-50 rounded-xl border-2 border-gray-200 transition-all duration-200 h-20">
                                {% if configuracion_sitio.imagen_plin %}
                                    <img src="{{ configuracion_sitio.imagen_plin.url }}" alt="Plin" class="h-8 object-contain">
                                {% else %}
                                    <span class="font-bold">Plin</span>
                                {% endif %}
                            </span>
                        </label>
                        <!-- === FIN DE LA MEJORA === -->

                        <label class="cursor-pointer">
                            <input type="radio" name="metodo_pago" value="tarjeta" class="hidden" onchange="togglePaymentFields(this.value)" required>
                            <span class="payment-card flex items-center justify-center p-4 bg-gray-50 rounded-xl border-2 border-gray-200 transition-all duration-200 h-20">
                                <i class="fas fa-credit-card text-3xl text-gray-600"></i>
                            </span>
                        </label>
                    </div>
                </div>
                
                <div id="payment-fields" class="space-y-4"></div>
                
                <button id="submit-button" type="submit" class="w-full text-white font-bold text-xl py-4 px-6 rounded-full shadow-lg transition-all duration-200 hover:scale-105 flex items-center justify-center" style="background-color: var(--brand-accent);">
                    <span id="button-text">Finalizar Compra</span>
                    <i id="button-spinner" class="fas fa-spinner fa-spin ml-3 hidden"></i>
                </button>
            </form>
        </div>
        
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl flex flex-col h-full order-first lg:order-last">
            <h1 class="text-4xl font-brand text-gray-800 mb-6">Resumen del Pedido</h1>
            
            <div class="flex-1 space-y-6">
                {% for item in cart_items %}
                    <div class="flex items-center space-x-4 border-b last:border-b-0 pb-4 last:pb-0">
                        <div class="flex-shrink-0 w-24 h-24 overflow-hidden rounded-xl border border-gray-200">
                            <img src="{{ item.image_url }}" alt="{{ item.name }}" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-lg" style="color: var(--brand-brown);">{{ item.name }}</p>
                            <p class="text-sm text-gray-500">Color: <span class="font-semibold capitalize">{{ item.color }}</span></p>
                            <p class="text-lg font-bold mt-1" style="color: var(--brand-accent);">S/{{ item.price }} x {{ item.quantity }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <div class="space-y-2 mt-6 pt-4 border-t-2 border-gray-100">
                <div class="flex justify-between items-center text-lg text-gray-800">
                    <span>Subtotal:</span>
                    <span id="subtotal-price" data-base-price="{{ total_price|floatformat:2 }}">S/{{ total_price|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between items-center text-lg text-gray-800">
                    <span>Costo de Envío:</span>
                    <span id="delivery-cost">S/0.00</span>
                </div>
                <div class="flex justify-between items-center font-bold text-2xl text-gray-800 mt-4 pt-2 border-t border-gray-200">
                    <span>Total:</span>
                    <span id="final-total" style="color: var(--brand-accent);">S/{{ total_price|floatformat:2 }}</span>
                </div>
            </div>
        </div>
    </div>
 </main>

<!-- Barra fija inferior SOLO móvil -->
<div id="mobile-summary-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl lg:hidden opacity-0 transition-opacity duration-300 hidden">
    <div class="flex flex-col">
        <span class="total-label">Total</span>
        <span id="mobile-final-total" class="total-value">—</span>
    </div>
    <button id="mobile-submit-btn" type="button">
        <span class="btn-text">Finalizar</span>
        <i class="fas fa-lock text-xs"></i>
    </button>
</div>

<div id="card-unavailable-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 hidden transition-opacity duration-300">
    <div class="relative w-full max-w-sm mx-auto p-8 rounded-3xl shadow-2xl bg-white text-center transform scale-95 transition-transform duration-300">
        <h3 class="text-2xl font-bold text-yellow-600 mb-4">Aviso Importante</h3>
        <p class="text-gray-600 mb-6">Por el momento, el pago con tarjeta no está disponible. Por favor, elige Yape o Plin para completar tu compra.</p>
        <button onclick="closeModal('card-unavailable-modal')" class="w-full px-6 py-3 bg-yellow-500 text-white font-bold rounded-full">Entendido</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Guardar último método de pago válido (no tarjeta) seleccionado
    let previousPaymentMethod = null;

    function updateDeliveryInfo(ciudad) {
        const deliveryCostElement = document.getElementById('delivery-cost');
        const subtotalElement = document.getElementById('subtotal-price');
        const finalTotalElement = document.getElementById('final-total');

        if (!deliveryCostElement || !subtotalElement || !finalTotalElement) return;

        const basePrice = parseFloat(subtotalElement.getAttribute('data-base-price'));
        let deliveryCost = (ciudad === 'Lima') ? 5.00 : 15.00;

        deliveryCostElement.textContent = `S/${deliveryCost.toFixed(2)}`;
        const finalTotal = basePrice + deliveryCost;
        finalTotalElement.textContent = `S/${finalTotal.toFixed(2)}`;
        
        const diasInput = document.getElementById('dias_envio');
        if(diasInput) diasInput.value = (ciudad === 'Lima') ? 'Aprox. 1 día hábil.' : 'Aprox. 3-5 días hábiles.';
    }
    
    function buildWalletFields(method) {
        const numeroYape = "{{ configuracion_sitio.numero_yape|default:'' }}".trim();
        const numeroPlin = "{{ configuracion_sitio.numero_plin|default:'' }}".trim();
        const legacy = "{{ configuracion_sitio.numero_yape_plin|default:'Número no configurado' }}".trim();
        let paymentNumber = legacy;
        if(method === 'yape' && numeroYape){ paymentNumber = numeroYape; }
        else if(method === 'plin' && numeroPlin){ paymentNumber = numeroPlin; }
        else if((method === 'yape' || method === 'plin') && !numeroYape && !numeroPlin){ paymentNumber = legacy; }
        const label = method.charAt(0).toUpperCase() + method.slice(1);
        let extraInfo = '';
        if(method==='yape' && numeroPlin){ extraInfo = `<p class=\"text-xs text-gray-500 mt-2\">También aceptamos Plin: <strong>${numeroPlin}</strong></p>`; }
        if(method==='plin' && numeroYape){ extraInfo = `<p class=\"text-xs text-gray-500 mt-2\">También aceptamos Yape: <strong>${numeroYape}</strong></p>`; }
        return `
            <div class="text-center p-4 bg-gray-100 rounded-xl">
                <p class="text-sm font-medium text-gray-700">Realiza el pago a través de ${label} al siguiente número:</p>
                <div class="flex items-center justify-center gap-3 mt-2">
                    <p id="payment-number" class="text-lg font-bold" style="color: var(--brand-accent);">${paymentNumber}</p>
                    <button type="button" onclick="copyToClipboard('${paymentNumber}')" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                        <i class="fas fa-copy mr-1"></i> Copiar
                    </button>
                </div>
                ${extraInfo}
            </div>`;
    }

    function togglePaymentFields(method) {
        const container = document.getElementById('payment-fields');
        if (!container) return;

        // Si el usuario selecciona tarjeta, mostrar aviso inmediato y revertir
        if (method === 'tarjeta') {
            showModal('card-unavailable-modal');
            const radios = document.querySelectorAll('input[name="metodo_pago"]');
            // Revertir a la opción previa si existía
            if (previousPaymentMethod) {
                radios.forEach(r => { r.checked = (r.value === previousPaymentMethod); });
                container.innerHTML = (previousPaymentMethod === 'yape' || previousPaymentMethod === 'plin') ? buildWalletFields(previousPaymentMethod) : '';
            } else {
                // Ningún método previo: simplemente desmarcar tarjeta y limpiar
                radios.forEach(r => { if (r.value === 'tarjeta') r.checked = false; });
                container.innerHTML = '';
            }
            return; // no continuamos
        }

        // Métodos válidos (yape / plin)
        container.innerHTML = '';
        if (method === 'yape' || method === 'plin') {
            container.innerHTML = buildWalletFields(method);
        }
        previousPaymentMethod = method; // guardar último válido
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('¡Número copiado!');
        }, (err) => {
            alert('No se pudo copiar el número.');
            console.error('Error al copiar: ', err);
        });
    }

    function handleFormSubmit(event) {
        const form = document.getElementById('checkout-form');
        const selectedPayment = form.querySelector('input[name="metodo_pago"]:checked');

        if (selectedPayment && selectedPayment.value === 'tarjeta') {
            event.preventDefault();
            showModal('card-unavailable-modal');
            return;
        }

        if (!form.checkValidity()) {
            return;
        }
        
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');

        submitButton.disabled = true;
        buttonText.textContent = 'Procesando...';
        buttonSpinner.classList.remove('hidden');
    }
    
    function fillAddressForm(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (!selectedOption.value) {
            document.getElementById('nombre').value = '{{ user.get_full_name|default:""|escapejs }}';
            document.getElementById('direccion').value = '';
            document.getElementById('celular').value = '';
            document.getElementById('referencia').value = '';
            document.getElementById('ciudad').value = 'Lima';
        } else {
            document.getElementById('nombre').value = selectedOption.dataset.nombre || '';
            document.getElementById('direccion').value = selectedOption.dataset.direccion || '';
            document.getElementById('celular').value = selectedOption.dataset.telefono || '';
            document.getElementById('referencia').value = selectedOption.dataset.referencia || '';
            const ciudadSelect = document.getElementById('ciudad');
            ciudadSelect.value = selectedOption.dataset.ciudad || 'Lima';
        }
        // Disparamos el evento 'change' para que se actualice el costo de envío
        document.getElementById('ciudad').dispatchEvent(new Event('change'));
    }

    document.addEventListener('DOMContentLoaded', () => {
        const ciudadSelect = document.getElementById('ciudad');
        if (ciudadSelect) {
            updateDeliveryInfo(ciudadSelect.value);
        }
    // Inicializar barra móvil
    initMobileBar();
    });

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('div[class*="transform"]').classList.remove('scale-95');
        }, 10);
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('opacity-0');
        modal.querySelector('div[class*="transform"]').classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    /* ============================= */
    /*   Funciones de barra móvil    */
    /* ============================= */
    function initMobileBar() {
        const bar = document.getElementById('mobile-summary-bar');
        if (!bar) return;
        // Mostrar solo si ancho < 1024
        if (window.innerWidth < 1024) {
            bar.classList.remove('hidden');
            requestAnimationFrame(() => bar.classList.add('show'));
            syncMobileTotal();
        }
        window.addEventListener('resize', () => {
            if (window.innerWidth < 1024) {
                bar.classList.remove('hidden');
                syncMobileTotal();
            } else {
                bar.classList.add('hidden');
            }
        });
        document.getElementById('mobile-submit-btn')?.addEventListener('click', () => {
            const form = document.getElementById('checkout-form');
            if (!form) return;
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            // Simular clic del botón original (oculto en móvil)
            handleFormSubmit(new Event('submit'));
            form.submit();
        });
        // Observador para cambios de total
        const finalTotal = document.getElementById('final-total');
        if (finalTotal && 'MutationObserver' in window) {
            const observer = new MutationObserver(syncMobileTotal);
            observer.observe(finalTotal, { childList: true, characterData: true, subtree: true });
        }
    }
    function syncMobileTotal() {
        const desktopTotal = document.getElementById('final-total');
        const mobileTotal = document.getElementById('mobile-final-total');
        if (desktopTotal && mobileTotal) {
            mobileTotal.textContent = desktopTotal.textContent.replace('Total:','').trim();
        }
    }
</script>
{% endblock %}