{% extends 'base.html' %}
{% load static %}

{% block meta_viewport %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
{% endblock %}

<!-- =================================================================== -->
<!-- === INICIO: Bloques para SEO y Redes Sociales === -->
<!-- =================================================================== -->

{% block title %}{{ producto.nombre }} - Fantas√≠a √çntima{% endblock %}

{% block meta_description %}{{ producto.descripcion|striptags|truncatewords:25 }}{% endblock %}

{% block og_title %}{{ producto.nombre }} | Fantas√≠a √çntima{% endblock %}
{% block og_description %}{{ producto.descripcion|striptags|truncatewords:25 }}{% endblock %}
{% if producto.imagen_principal %}
    {# CORRECCI√ìN: Se construye la URL absoluta de forma manual para evitar el TemplateSyntaxError #}
    {% block og_image %}{{ request.scheme }}://{{ request.get_host }}{{ producto.imagen_principal.url }}{% endblock %}
{% endif %}

{% block twitter_title %}{{ producto.nombre }} | Fantas√≠a √çntima{% endblock %}
{% block twitter_description %}{{ producto.descripcion|striptags|truncatewords:25 }}{% endblock %}
{% if producto.imagen_principal %}
    {# CORRECCI√ìN: Se construye la URL absoluta de forma manual para evitar el TemplateSyntaxError #}
    {% block twitter_image %}{{ request.scheme }}://{{ request.get_host }}{{ producto.imagen_principal.url }}{% endblock %}
{% endif %}

<!-- =================================================================== -->
<!-- === FIN: Bloques para SEO y Redes Sociales === -->
<!-- =================================================================== -->


{% block breadcrumbs %}
<nav class="text-sm text-gray-500" aria-label="Breadcrumb">
    <ol class="list-none p-0 inline-flex flex-wrap">
        <li class="flex items-center">
            <!-- Breadcrumb de Inicio removido -->
            <span class="mx-2">/</span>
        </li>
        <li class="flex items-center">
             <a href="{% url 'catalogo_publico' %}" class="hover:text-[--brand-accent]">Cat√°logo</a>
            <span class="mx-2">/</span>
        </li>
        {% if producto.categoria.parent %}
        <li class="flex items-center">
            <a href="{% url 'catalogo_publico' %}?categoria={{ producto.categoria.parent.slug }}" class="hover:text-[--brand-accent] capitalize">{{ producto.categoria.parent.nombre }}</a>
            <span class="mx-2">/</span>
        </li>
        {% endif %}
        <li class="flex items-center">
            <a href="{% url 'catalogo_publico' %}?categoria={{ producto.categoria.slug }}" class="hover:text-[--brand-accent] capitalize">{{ producto.categoria.nombre }}</a>
            <span class="mx-2">/</span>
        </li>
        <li class="flex items-center">
            <span class="font-semibold text-gray-700">{{ producto.nombre }}</span>
        </li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    .zoom-container {
        width: 100%;
        overflow: hidden;
        border-radius: 1.5rem;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
        border: 1px solid rgb(243 244 246);
    }
    .zoom-image {
        width: 100%;
        height: auto;
        display: block;
        cursor: zoom-in;
        transition: transform 0.3s ease;
        transform-origin: center;
    }
    .color-selector {
        box-shadow: 0 0 0 2px #d1d5db;
        transition: all 0.2s ease-in-out;
    }
    .color-selector.selected { box-shadow: 0 0 0 3px var(--brand-accent, #e91e63); transform: scale(1.07); }
    /* ======= Mejoras Mobile ======= */
    @media (max-width: 640px) {
    .product-detail-card { padding: .45rem .6rem .85rem; gap:.42rem; }
    .product-detail-wrapper { padding-bottom: .6rem; }
    .zoom-container { margin-bottom:.3rem; }
    .variant-scroll { margin-top:.2rem !important; }
    :root{ --pd-font: 1rem; }
    /* T√≠tulo = Precio (mismo tama√±o) */
    .mobile-title { font-size: var(--pd-font) !important; line-height: 1.1; margin-bottom:.08rem; letter-spacing:.15px; }
    #product-code-{{ producto.id }} { margin-bottom:0; font-size:.67rem; letter-spacing:.5px; }
    .sku-row { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin-bottom:.35rem; }
    /* En m√≥vil el stock se reubica al lado del SKU mediante JS */
    .product-detail-card p.text-4xl { font-size: var(--pd-font) !important; line-height:1.1; margin-bottom:.02rem; }
    .product-detail-card p.text-2xl { font-size:.8rem; }
    .product-detail-card p.text-gray-600 { font-size:.8rem; line-height:1.2; margin-top:.08rem; margin-bottom:.18rem; display:-webkit-box; -webkit-line-clamp:1; line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; }
    /* Extra compacto en pantallas muy estrechas */
    @media (max-width: 380px) {
        .product-detail-card p.text-gray-600 { -webkit-line-clamp:1; line-clamp:1; font-size:.75rem; }
    }
    .quantity-row { margin-bottom:.3rem; }
    .quantity-row span:first-child{ font-size:.85rem; margin-right:.5rem; }
    .quantity-row button{ width:2rem !important; height:2rem !important; }
    .quantity-row input[type="number"]{ width:2.25rem !important; font-size:.85rem; }
    .price-row{ column-gap:.18rem; margin-bottom:.22rem !important; }
    .variant-scroll { -webkit-overflow-scrolling: touch; padding:.15rem .25rem .3rem; scroll-snap-type:x mandatory; gap:.5rem; }
        .variant-scroll::-webkit-scrollbar { display:none; }
        .variant-scroll .color-selector { scroll-snap-align:center; }
    .color-selector { width:1.2rem; height:1.2rem; border:2px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.09); }
        .color-selector.selected { transform: scale(1.15); box-shadow:0 0 0 2px var(--brand-accent, #e91e63),0 0 0 1px #fff inset; }
        .price-pill { backdrop-filter:blur(4px); }
    /* Acciones en fila: cantidad + bot√≥n (solo m√≥vil) */
    .actions-row { display:flex; align-items:center; gap:.5rem; margin-bottom:.35rem; }
    .quantity-row { margin-bottom: 0; flex: 1 1 auto; }
    .add-to-cart-main { position: static; transform:none; width:auto; flex:0 0 auto; box-shadow: 0 5px 12px -10px rgba(var(--brand-primary-rgb, 233,30,99), .45); border-radius: 9999px; font-size:.78rem; height:2rem; padding:0 .72rem; display:inline-flex; align-items:center; white-space: nowrap; }
    .add-to-cart-main i{ margin-right:.28rem !important; }
        .add-to-cart-main:active { transform:none; }
    [data-stock-message] span { display:inline-block; padding:.25rem .55rem; border-radius:9999px; font-size:.6rem; letter-spacing:.45px; }
        [data-stock-message] .text-gray-500 { background:#f3f4f6; }
    }
    @media (min-width: 641px) {
        .variant-scroll { flex-wrap:wrap; overflow:visible; padding: .25rem .5rem .25rem; }
    .variant-scroll .color-selector { width:3.25rem; height:3.25rem; }
    }
    /* Bloqueo de scroll cuando hay zoom activo */
    body.disable-scroll { overflow:hidden; touch-action:none; }
</style>
{% endblock %}

{% block content %}
<main class="container mx-auto p-4 md:p-8 product-detail-wrapper">
    <div class="bg-white p-6 md:p-10 rounded-3xl shadow-xl grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16 product-detail-card">
        
        <!-- Columna de la imagen del producto -->
        <div>
            <div class="relative">
                <div id="zoom-container-{{ producto.id }}" class="zoom-container mb-4">
                    <img id="zoom-image-{{ producto.id }}"
                         class="zoom-image"
                         src="{% if producto.variantes.first.imagen %}{{ producto.variantes.first.imagen.url }}{% elif producto.imagen_principal %}{{ producto.imagen_principal.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                         alt="Imagen de {{ producto.nombre }}"
                         role="img"
                    />
                </div>
                <div class="absolute top-4 right-4 z-10">
                    {% if producto.es_nueva_coleccion %}
                        <div class="inline-flex items-center text-xs md:text-sm uppercase tracking-wider font-bold text-white px-3 py-1.5 rounded-full shadow-md"
                             style="background: linear-gradient(145deg, var(--brand-accent), var(--brand-primary, #f9a8d4));">
                            Nueva Colecci√≥n
                        </div>
                    {% endif %}
                </div>
                <div class="absolute bottom-4 right-4 z-10">
                    {% if producto.descuento_porcentaje > 0 %}
                        <div class="bg-red-500 text-white text-sm font-bold px-3 py-1.5 rounded-full shadow-md">
                            -{{ producto.descuento_porcentaje|floatformat:0 }}%
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex flex-nowrap md:flex-wrap justify-start md:justify-center gap-3 mt-4 overflow-x-auto variant-scroll px-1 -mx-1" style="scrollbar-width: none;">
                {% for variante in producto.variantes.all %}
                      <!-- === INICIO DE LA MEJORA: L√≥gica de Textura vs. Color S√≥lido === -->
                    <div 
                        class="color-selector rounded-full cursor-pointer bg-cover bg-center shrink-0 variante-trigger {% if forloop.first %}selected{% endif %}"
                        data-product-id="{{ producto.id }}"
                        data-image-url="{{ variante.imagen.url }}"
                        data-stock="{{ variante.stock_disponible }}"
                        data-variant-id="{{ variante.pk }}"
                        data-code="{{ variante.codigo|default:'N/A' }}"
                        {% if variante.imagen_textura %}
                            style="background-image: url('{{ variante.imagen_textura.url }}');"
                        {% else %}
                            style="background-color: {{ variante.color | lower }};"
                        {% endif %}
                        title="{{ variante.codigo|default:'Sin c√≥digo' }}" aria-label="Variante {{ variante.codigo|default:'Sin c√≥digo' }}">
                    </div>
                    <!-- === FIN DE LA MEJORA === -->
                {% endfor %}
            </div>
        </div>
        
        <!-- Columna de los detalles del producto -->
        <div class="flex flex-col justify-center">
            <h1 class="text-3xl md:text-5xl font-bold mb-2 leading-tight mobile-title" style="color: var(--brand-brown);">{{ producto.nombre }}</h1>
            
            <div id="sku-row-{{ producto.id }}" class="text-sm text-gray-400 mb-4 font-mono sku-row">
                SKU: <span id="product-code-{{ producto.id }}">{% if producto.variantes.first.codigo %}{{ producto.variantes.first.codigo }}{% else %}N/A{% endif %}</span>
            </div>

            <div class="flex items-baseline mb-6 space-x-3 price-row">
                {% if producto.precio_oferta %}
                    <p class="text-4xl font-extrabold text-red-600">S/{{ producto.precio_oferta|floatformat:2 }}</p>
                    <p class="text-2xl font-medium text-gray-400 line-through">S/{{ producto.precio|floatformat:2 }}</p>
                {% else %}
                    <p class="text-4xl font-extrabold text-[--brand-accent]">S/{{ producto.precio|floatformat:2 }}</p>
                {% endif %}
            </div>

            <p class="text-gray-600 text-lg mb-6 leading-relaxed break-words">{{ producto.descripcion }}</p>
            
            <div id="stock-container-{{ producto.id }}" class="mb-6">
                <p id="stock-message-{{ producto.id }}" class="text-sm" data-stock-message>
                    {% with stock_inicial=initial_stock|default:0 %}
                        {% if stock_inicial <= 0 %}
                            <span class="font-bold text-red-600">Agotado</span>
                        {% elif stock_inicial == 1 %}
                            <span class="font-bold text-orange-600">¬°√öltima unidad en stock!</span>
                        {% elif stock_inicial < 5 %}
                            <span class="font-bold text-orange-500">¬°√öltimas <span id="stock-{{ producto.id }}">{{ stock_inicial }}</span> unidades!</span>
                        {% else %}
                            <span class="text-gray-500">
                                Stock disponible: 
                                <span id="stock-{{ producto.id }}" class="font-bold text-gray-800">{{ stock_inicial }}</span> 
                                unidades
                            </span>
                        {% endif %}
                    {% endwith %}
                </p>
            </div>
            
            <form id="form-add-to-cart-{{ producto.id }}" method="post" action="{% url 'add_to_cart' %}" onsubmit="handleAddToCart(event, {{ producto.id }})">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ producto.pk }}">
                <input type="hidden" name="variant_id" id="variant_id-{{ producto.id }}" value="{% if producto.variantes.first %}{{ producto.variantes.first.pk }}{% endif %}">
                
                {% with stock_inicial=initial_stock|default:0 %}
                <div class="actions-row md:block">
                    <div class="flex items-center mb-6 quantity-row">
                        <span class="mr-6 font-bold text-gray-700">Cantidad:</span>
                        <div class="flex items-center border rounded-full overflow-hidden shadow-sm">
                            <button type="button" onclick="changeQuantity({{ producto.id }}, -1)" class="bg-gray-200 text-gray-700 w-10 h-10 flex items-center justify-center hover:bg-gray-300 transition-colors duration-200" {% if stock_inicial <= 0 %}disabled{% endif %}>-</button>
                            <input 
                                type="number" 
                                name="quantity" 
                                id="quantity-{{ producto.id }}" 
                                value="{% if stock_inicial > 0 %}1{% else %}0{% endif %}" 
                                min="{% if stock_inicial > 0 %}1{% else %}0{% endif %}"
                                max="{{ stock_inicial }}"
                                class="w-16 text-center bg-white text-gray-800 focus:outline-none"
                                onchange="validateQuantity({{ producto.id }})"
                                {% if stock_inicial <= 0 %}disabled{% endif %}
                            >
                            <button type="button" onclick="changeQuantity({{ producto.id }}, 1)" class="bg-gray-200 text-gray-700 w-10 h-10 flex items-center justify-center hover:bg-gray-300 transition-colors duration-200" {% if stock_inicial <= 0 %}disabled{% endif %}>+</button>
                        </div>
                    </div>

                    <button type="submit" class="text-white font-bold rounded-full shadow-lg transition-transform duration-200 hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed add-to-cart-main flex items-center justify-center" style="background-color: var(--brand-accent);" {% if stock_inicial <= 0 %}disabled{% endif %}>
                        <i class="fas fa-shopping-cart mr-3"></i>
                        A√±adir al Carrito
                    </button>
                </div>
                {% endwith %}
            </form>
        </div>
    </div>
</main>

<section class="container mx-auto p-4 md:p-8 mt-12">
    <h2 class="text-3xl font-bold text-center mb-8 text-[--brand-brown]">Tambi√©n te podr√≠a interesar</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
        {% for relacionado in productos_relacionados %}
            {% include 'partials/_product_card.html' with producto=relacionado %}
        {% empty %}
            <p class="col-span-full text-center text-gray-500">No hay productos relacionados para mostrar.</p>
        {% endfor %}
    </div>
</section>

<!-- Modales -->
<div id="add-to-cart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden">
    <div class="relative w-full max-w-sm mx-auto p-8 rounded-3xl shadow-2xl bg-white text-center transform transition-transform duration-300 scale-95">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">¬°Producto A√±adido!</h3>
        <p class="text-sm text-gray-600 mb-6">El producto ha sido a√±adido al carrito con √©xito.</p>
        <!-- --- INICIO DE LA MEJORA: Mensaje de caducidad --- -->
        <div class="p-3 bg-yellow-50 text-yellow-800 text-sm rounded-lg mb-6 flex items-center justify-center gap-2">
            <i class="fas fa-clock"></i>
            <span>Recuerda que los productos en tu carrito se reservan por 24 horas.</span>
        </div>
        <!-- --- FIN DE LA MEJORA --- -->
        <div class="flex flex-col space-y-4">
            <a href="{% url 'ver_carrito' %}" class="px-6 py-3 text-white font-bold rounded-full transition-colors duration-300" style="background-color: var(--brand-accent);">Ir al Carrito</a>
            <a href="{% url 'catalogo_publico' %}" class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-full hover:bg-gray-300 transition-colors duration-300">Seguir Comprando</a>
            <button onclick="closeModal('add-to-cart-modal')" class="px-6 py-3 text-gray-600 font-bold rounded-full hover:bg-gray-100 transition-colors duration-300">Cerrar</button>
        </div>
    </div>
</div>
<div id="error-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 hidden">
    <div class="relative w-full max-w-sm mx-auto p-8 rounded-3xl shadow-2xl bg-white text-center transform transition-transform duration-300 scale-95">
        <h3 class="text-2xl font-bold text-red-600 mb-4">¬°Error!</h3>
        <p id="error-message" class="text-sm text-gray-600 mb-6">Hubo un error.</p>
        <button onclick="closeModal('error-modal')" class="w-full px-6 py-3 bg-red-500 text-white font-bold rounded-full hover:bg-red-600 transition-colors duration-300">Entendido</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        setupImageZoom('{{ producto.id }}');
        // Delegaci√≥n de eventos para variantes (evita inline JS y mejora rendimiento)
        document.querySelectorAll('.variante-trigger').forEach(el => {
            el.addEventListener('click', (e) => {
                const t = e.currentTarget;
                changeProductImageAndStock(
                    e,
                    t.dataset.productId,
                    t.dataset.imageUrl,
                    t.dataset.stock,
                    t.dataset.variantId,
                    t.dataset.code
                );
            });
        });

        // Reubicar stock junto al SKU solo en m√≥vil
        const pid = '{{ producto.id }}';
        const mq = window.matchMedia('(max-width: 640px)');
        function relocateStock() {
            const skuRow = document.getElementById('sku-row-' + pid);
            const stockContainer = document.getElementById('stock-container-' + pid);
            const stockMessage = document.getElementById('stock-message-' + pid);
            if (!skuRow || !stockContainer || !stockMessage) return;
            if (mq.matches) {
                if (stockMessage.parentElement !== skuRow) {
                    skuRow.appendChild(stockMessage);
                    stockMessage.style.display = 'inline';
                    stockMessage.style.margin = '0';
                }
                // Ocultar el contenedor vac√≠o para evitar espacio extra
                stockContainer.style.display = 'none';
            } else {
                if (stockMessage.parentElement !== stockContainer) {
                    stockContainer.appendChild(stockMessage);
                    stockMessage.style.display = '';
                    stockMessage.style.margin = '';
                }
                // Mostrar de nuevo en desktop
                stockContainer.style.display = '';
            }
        }
        relocateStock();
        mq.addEventListener ? mq.addEventListener('change', relocateStock) : window.addEventListener('resize', relocateStock);
    });

    function changeProductImageAndStock(event, productId, imageUrl, stock, variantId, productCode) {
        const zoomImage = document.getElementById('zoom-image-' + productId);
        const stockMessageElement = document.getElementById('stock-message-' + productId);
        const variantInput = document.getElementById('variant_id-' + productId);
        const quantityInput = document.getElementById('quantity-' + productId);
        const addToCartButton = document.querySelector(`#form-add-to-cart-${productId} button[type="submit"]`);
        const qtyButtons = document.querySelectorAll(`#form-add-to-cart-${productId} button[type="button"]`);
    const codeElement = document.getElementById('product-code-' + productId);
    const stockInline = document.getElementById('stock-inline-' + productId);

        document.querySelectorAll('.color-selector').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        if(zoomImage) zoomImage.src = imageUrl;
        if(variantInput) variantInput.value = variantId;
    if(codeElement) codeElement.innerText = `${productCode}`;

        if (zoomImage) {
            zoomImage.style.transform = 'scale(1)';
            zoomImage.style.transformOrigin = 'center';
            zoomImage.style.cursor = 'zoom-in';
        }

        const stockNum = parseInt(stock);
        
        if (stockMessageElement) {
            if (stockNum <= 0) {
                stockMessageElement.innerHTML = `<span class="font-bold text-red-600">Agotado</span>`;
            } else if (stockNum < 5) {
                stockMessageElement.innerHTML = `<span class="font-bold text-orange-500">¬°√öltimas <span id="stock-${productId}">${stockNum}</span> unidades!</span>`;
            } else {
                stockMessageElement.innerHTML = `<span class="text-gray-500">Stock disponible: <span id="stock-${productId}" class="font-bold text-gray-800">${stockNum}</span> unidades</span>`;
            }
        }

        // Actualizar stock inline solo m√≥vil
        if (stockInline) {
            if (stockNum <= 0) {
                stockInline.innerHTML = `<span class="stock-inline-pill out">Agotado</span>`;
            } else if (stockNum < 5) {
                stockInline.innerHTML = `<span class="stock-inline-pill low">√öltimas ${stockNum}</span>`;
            } else {
                stockInline.innerHTML = `<span class="stock-inline-pill ok">Stock: <strong>${stockNum}</strong></span>`;
            }
        }

        if(quantityInput) {
            quantityInput.max = stockNum;
            const isOutOfStock = stockNum <= 0;
            quantityInput.value = isOutOfStock ? 0 : 1;
            quantityInput.min = isOutOfStock ? 0 : 1;
            quantityInput.disabled = isOutOfStock;
            if(addToCartButton) addToCartButton.disabled = isOutOfStock;
            qtyButtons.forEach(btn => btn.disabled = isOutOfStock);
        }
    }
    
function setupImageZoom(productId) {
    console.debug('setupImageZoom()', productId);
    const zoomContainer = document.getElementById('zoom-container-' + productId);
    const zoomImage = document.getElementById('zoom-image-' + productId);
    if (!zoomContainer || !zoomImage) {
        console.debug('setupImageZoom: elementos no encontrados', { zoomContainer, zoomImage });
        return;
    }

    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // ================== üì± CELULAR ==================
    if (isTouchDevice) {
        const MAX_SCALE = parseFloat('{{ product_zoom_factor|default:2.0 }}') || 2;
        let scale = 1;
        let startX = 0, startY = 0;
        let currentX = 0, currentY = 0;
        let initialDistance = null;
        let pinchStartScale = 1;
        let lastTap = 0;

        const clamp = (v,min,max)=> Math.min(Math.max(v,min),max);
        zoomImage.style.willChange = 'transform';
        try { zoomContainer.style.touchAction='manipulation'; } catch(e){}

        function applyTransform(){
            zoomImage.style.transform = `scale(${scale}) translate(${currentX}px, ${currentY}px)`;
        }
        function resetZoom(){
            scale=1; currentX=0; currentY=0; zoomImage.style.transition='transform .25s ease';
            zoomImage.style.transform='scale(1) translate(0,0)';
            try { zoomContainer.style.touchAction='manipulation'; } catch(e){}
        }

        function handleTouchStart(e){
            const now = Date.now();
            const delta = now - lastTap;
            if(e.touches.length===1 && delta>0 && delta<300){
                if(scale===1){
                    scale=MAX_SCALE; currentX=0; currentY=0; zoomImage.style.transition='transform .22s ease';
                    applyTransform();
                    try { zoomContainer.style.touchAction='none'; } catch(err){}
                } else {
                    resetZoom();
                }
            }
            lastTap = now;

            if(e.touches.length===1){
                const t=e.touches[0];
                startX = t.clientX - currentX;
                startY = t.clientY - currentY;
            } else if(e.touches.length===2){
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                initialDistance = Math.hypot(dx,dy);
                pinchStartScale = scale;
            }
        }

        function handleTouchMove(e){
            if(e.touches.length===2){
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const dist = Math.hypot(dx,dy);
                if(initialDistance){
                    let newScale = pinchStartScale * (dist / initialDistance);
                    newScale = clamp(newScale, 1, MAX_SCALE);
                    scale = newScale;
                    if(scale>1){
                        try { zoomContainer.style.touchAction='none'; } catch(err){}
                    } else {
                        try { zoomContainer.style.touchAction='manipulation'; } catch(err){}
                    }
                    applyTransform();
                }
            } else if(e.touches.length===1 && scale>1){
                e.preventDefault();
                const t=e.touches[0];
                currentX = t.clientX - startX;
                currentY = t.clientY - startY;
                // l√≠mites
                const rect = zoomContainer.getBoundingClientRect();
                const imgW = zoomImage.offsetWidth;
                const imgH = zoomImage.offsetHeight;
                const maxX = (imgW * scale - rect.width) / (2 * scale);
                const maxY = (imgH * scale - rect.height) / (2 * scale);
                currentX = clamp(currentX, -maxX, maxX);
                currentY = clamp(currentY, -maxY, maxY);
                zoomImage.style.transition='none';
                applyTransform();
            }
        }

        function handleTouchEnd(){
            initialDistance = null;
            if(scale<=1){
                resetZoom();
            }
        }

        zoomContainer.addEventListener('touchstart', handleTouchStart, {passive:false});
        zoomContainer.addEventListener('touchmove', handleTouchMove, {passive:false});
        zoomContainer.addEventListener('touchend', handleTouchEnd);
    }
    // ================== üíª LAPTOP / PC ==================
    else {
        const handleMouseMove = (e) => {
            const { left, top, width, height } = zoomContainer.getBoundingClientRect();
            const x = (e.clientX - left) / width * 100;
            const y = (e.clientY - top) / height * 100;
            zoomImage.style.transformOrigin = `${x}% ${y}%`;
        };

        const handleMouseEnter = () => {
            zoomImage.style.transform = 'scale(' + (parseFloat('{{ product_zoom_factor|default:2.0 }}') || 2) + ')';
            zoomImage.style.cursor = 'zoom-out';
        };

        const handleMouseLeave = () => {
            zoomImage.style.transform = 'scale(1)';
            zoomImage.style.transformOrigin = 'center';
            zoomImage.style.cursor = 'zoom-in';
        };

        zoomContainer.addEventListener('mousemove', handleMouseMove);
        zoomContainer.addEventListener('mouseenter', handleMouseEnter);
        zoomContainer.addEventListener('mouseleave', handleMouseLeave);
    }

    }


    async function handleAddToCart(event, productId) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        const quantityInput = document.getElementById('quantity-' + productId);
        if (parseInt(quantityInput.value) > parseInt(quantityInput.max) || parseInt(quantityInput.value) <= 0) {
            showErrorModal('La cantidad seleccionada no es v√°lida o no hay stock.');
            return;
        }

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.success) {
                const cartCountBadge = document.getElementById('cart-count-badge');
                if (cartCountBadge && typeof data.cart_count !== 'undefined') {
                    cartCountBadge.textContent = data.cart_count;
                }
                // Actualizar stock mostrado y max del input si viene current_available
                if (typeof data.current_available !== 'undefined') {
                    const stockSpan = document.getElementById('stock-{{ producto.id }}');
                    const quantityInput = document.getElementById('quantity-{{ producto.id }}');
                    const stockMsg = document.getElementById('stock-message-{{ producto.id }}');
                    const available = parseInt(data.current_available);
                    if (stockSpan) stockSpan.textContent = available;
                    if (quantityInput) quantityInput.max = available;
                    if (stockMsg) {
                        if (available <= 0) {
                            stockMsg.innerHTML = '<span class="font-bold text-red-600">Agotado</span>';
                        } else if (available < 5) {
                            stockMsg.innerHTML = `<span class="font-bold text-orange-500">¬°√öltimas <span id="stock-{{ producto.id }}">${available}</span> unidades!</span>`;
                        } else {
                            stockMsg.innerHTML = `
                                <span class="text-gray-500">
                                    Stock disponible: 
                                    <span id="stock-{{ producto.id }}" class="font-bold text-gray-800">${available}</span> 
                                    unidades
                                </span>`;
                        }
                    }
                }
                showModal('add-to-cart-modal');
            } else {
                showErrorModal(data.error || 'Hubo un error al a√±adir el producto.');
            }
        } catch (error) {
            showErrorModal('Ocurri√≥ un problema de conexi√≥n. Por favor, int√©ntalo de nuevo.');
        }
    }
    
    function changeQuantity(productId, change) {
        const quantityInput = document.getElementById('quantity-' + productId);
        if(!quantityInput) return;
        let currentValue = parseInt(quantityInput.value);
        let newValue = currentValue + change;
        const maxStock = parseInt(quantityInput.max);
        const minVal = parseInt(quantityInput.min);

        if (newValue < minVal) newValue = minVal;
        if (newValue > maxStock) newValue = maxStock;

        quantityInput.value = newValue;
    }

    function validateQuantity(productId) {
        const quantityInput = document.getElementById('quantity-' + productId);
        if(!quantityInput) return;
        let value = parseInt(quantityInput.value);
        const maxStock = parseInt(quantityInput.max);
        const minVal = parseInt(quantityInput.min);

        if (isNaN(value) || value < minVal) {
            quantityInput.value = minVal;
        } else if (value > maxStock) {
            quantityInput.value = maxStock;
        }
    }
    
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div[class*="transform"]').classList.remove('scale-95');
            }, 10);
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('div[class*="transform"]').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    }

    function showErrorModal(message) {
        const errorMessageElement = document.getElementById('error-message');
        if (errorMessageElement) {
            errorMessageElement.textContent = message;
        }
        showModal('error-modal');
    }
</script>
{% endblock %}